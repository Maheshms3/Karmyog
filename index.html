<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karmyog - Your Path of AbhyƒÅsa</title>
  <link rel="canonical" href="https://karmyog.life/"/>

  <!-- PWA -->
  <meta name="theme-color" content="#1e293b"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icons/icon-192x192.png"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' }; </script>

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    body{font-family:'Inter',sans-serif;user-select:none;overflow-x:hidden;}
    .karma-item{transition:opacity .5s ease,transform .5s ease;position:relative;}
    .karma-item.completed{opacity:0;transform:scale(.5) translateX(100%);}
    .fire-overlay{position:absolute;inset:0;background:rgba(255,165,0,.1);display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:.75rem;}
    .karma-positive{color:#22c55e}.karma-negative{color:#ef4444}.karma-neutral{color:#64748b}
    .badge{transition:transform .3s ease,filter .3s ease}.badge.unlocked{filter:none}.badge.locked{filter:grayscale(100%) opacity(.4)}.badge:hover{transform:scale(1.1)}
    #sidebar{transition:transform .3s ease-in-out}#sidebar-overlay{transition:opacity .3s ease-in-out}
    .vikarma-card{background-color:#fef2f2}.dark .vikarma-card{background-color:rgba(153,27,27,.2)}
    .prayashchit-card{background-color:#fffbeb}.dark .prayashchit-card{background-color:rgba(180,83,9,.2)}
    .dragging{opacity:.5;cursor:grabbing}.score-value{transition:color .5s ease}
    .modal-enter{animation:fadeIn .3s ease-out forwards}@keyframes fadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    #installBtn{position:fixed;right:1rem;bottom:4.5rem;padding:.7rem 1rem;border:0;border-radius:.6rem;font:600 14px/1.2 system-ui,sans-serif;background:#4f46e5;color:#fff;cursor:pointer;display:none;z-index:100}
    .badge-ceremony-icon{animation:spin-and-glow 1.5s ease-in-out}@keyframes spin-and-glow{0%{transform:scale(.5) rotate(0);filter:drop-shadow(0 0 0 white)}50%{transform:scale(1.2) rotate(360deg);filter:drop-shadow(0 0 15px white)}100%{transform:scale(1) rotate(360deg);filter:drop-shadow(0 0 5px white)}}
    .with-bottom-nav{padding-bottom:0}

    /* ===================== Daily Journal UI ===================== */
    /* Draggable Minimal Pen */
    #pen-fab{
      position:fixed; z-index:60; width:44px; height:44px; border-radius:9999px;
      display:grid; place-items:center; cursor:grab;
      /* glassy + transparent */
      background:rgba(255,255,255,.6);
      border:1px solid rgba(0,0,0,.12);
      box-shadow:0 6px 20px rgba(0,0,0,.15);
      backdrop-filter:saturate(120%) blur(6px);
      /* default position if no saved pos */
      right:16px; bottom:16px;
    }
    .dark #pen-fab{ background:rgba(2,6,23,.4); border-color:rgba(255,255,255,.12); color:#fff; }
    #pen-fab:active{ cursor:grabbing; }

    /* Journal page */
    #journal{ position:fixed; inset:0; z-index:70; display:none; }
    #journal.show{ display:block; }
    #journal .sheet{
      position:absolute; inset:0;
      background:#fff; color:#0f172a;
    }
    .dark #journal .sheet{ background:#fff; color:#0f172a; } /* always white page per request */

    #journal header{
      height:52px; display:flex; align-items:center; gap:.5rem;
      padding:0 .75rem; border-bottom:1px solid #e5e7eb;
    }
    #journal .date-badge{
      margin-left:auto; display:flex; align-items:center; gap:.5rem;
      font-weight:600;
    }
    #journal .date-badge input[type="date"]{
      opacity:0; position:absolute; inset:0; width:100%; height:100%; cursor:pointer;
    }
    #journal main{ display:grid; grid-template-columns:1fr 280px; height:calc(100dvh - 52px); }
    #journal textarea{
      width:100%; height:100%; padding:18px;
      border:0; outline:0; font-size:16px; line-height:1.6; resize:none;
      background:#fff; color:#0f172a;
    }
    #journal aside{ border-left:1px solid #e5e7eb; overflow:auto; }
    #journal aside .head{ position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; padding:10px 12px; font-weight:700; }
    #journal .note-item{ width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; border-bottom:1px solid #f2f2f2; cursor:pointer;}
    #journal .note-item .date{ font-size:12px; opacity:.7; }
    #journal .note-item .preview{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

  <!-- Login Overlay -->
  <div id="auth-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-95 z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-sm text-center">
      <h1 class="text-5xl font-bold text-white mb-2">Karmyog</h1>
      <p class="text-slate-400 mb-8">Sign in to begin your path of AbhyƒÅsa.</p>
      <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl">
        <button id="google-signin-btn" class="w-full bg-white hover:bg-slate-200 text-slate-800 font-semibold py-3 px-4 rounded-lg flex items-center justify-center transition-transform transform hover:scale-105" aria-label="Sign in with Google">
          <img src="https://www.google.com/favicon.ico" alt="Google icon" class="w-6 h-6 mr-3"> Sign in with Google
        </button>
        <a href="#" id="google-redirect-fallback" class="hidden mt-4 text-sm text-indigo-400 hover:text-indigo-300">Pop-up blocked? Try alternate sign-in</a>
        <div class="my-6 flex items-center"><hr class="w-full border-slate-600"><span class="px-4 text-slate-500 text-sm">OR</span><hr class="w-full border-slate-600"></div>
        <form id="email-form">
          <input type="email" id="email-input" placeholder="Email" class="w-full bg-slate-700 text-white p-3 rounded-lg mb-4 border-2 border-transparent focus:border-indigo-500 focus:ring-0" required>
          <input type="password" id="password-input" placeholder="Password (6+ characters)" class="w-full bg-slate-700 text-white p-3 rounded-lg mb-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0" required>
          <div class="text-right mb-4">
            <button type="button" id="forgot-password-btn" class="text-xs text-indigo-300 hover:text-indigo-200 underline">Forgot password?</button>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button type="button" id="email-signin-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Sign In</button>
            <button type="button" id="email-signup-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg">Sign Up</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden" aria-hidden="true"></div>
  <div id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white dark:bg-slate-800 shadow-xl z-40 transform -translate-x-full p-6 flex flex-col" role="dialog" aria-label="Sidebar">
    <div class="flex-grow overflow-y-auto pr-2">
      <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">Your AbhyƒÅsa</h2>
      <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg mb-6">
        <input type="text" id="goal-name-input" placeholder="New Practice Name..." class="w-full bg-white dark:bg-slate-600 p-2 rounded-md mb-2">
        <button id="add-goal-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-md">Create Practice</button>
      </div>
      <div id="sidebar-goal-list" class="space-y-4"></div>

      <div class="mt-8">
        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Badges</h3>
        <div id="sidebar-badge-container" class="grid grid-cols-4 gap-4 text-center"></div>
      </div>

      <!-- Reminders & End Day Settings -->
      <div class="mt-8 bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
        <h3 class="text-xl font-bold mb-3">Reminders</h3>
        <label class="flex items-center justify-between mb-2">
          <span class="text-sm">In-app reminders</span>
          <input id="toggle-inapp-reminders" type="checkbox" class="scale-125">
        </label>
        <label class="flex items-center justify-between mb-2">
          <span class="text-sm">Web push (optional)</span>
          <input id="toggle-push-reminders" type="checkbox" class="scale-125">
        </label>
        <div class="grid grid-cols-2 gap-3 mt-3">
          <div>
            <label class="block text-xs mb-1">End Day Time</label>
            <input id="endday-time" type="time" class="w-full bg-white dark:bg-slate-600 p-2 rounded-md">
          </div>
          <div>
            <label class="block text-xs mb-1">Auto finalize (mins)</label>
            <input id="auto-finalize-mins" type="number" min="5" step="5" class="w-full bg-white dark:bg-slate-600 p-2 rounded-md">
          </div>
        </div>
      </div>
    </div>

    <div class="mt-auto pt-6 border-t border-slate-200 dark:border-slate-700 flex-shrink-0">
      <button id="reset-karma-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors mb-4">Reset Accumulated Karma</button>
      <button id="reset-day-btn" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg">End Day &amp; Evaluate</button>
    </div>
  </div>

  <!-- Main App Content -->
  <div id="app-container" class="hidden container mx-auto max-w-2xl p-4 sm:p-6 with-bottom-nav">
    <header class="text-center mb-6 relative flex items-center justify-between">
      <button id="menu-btn" class="text-2xl text-slate-800 dark:text-slate-200" aria-label="Open menu"><i class="fas fa-bars"></i></button>
      <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white">Karmyog</h1>
      <div class="flex items-center gap-2">
        <button id="theme-toggle-btn" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-xs font-semibold py-2 px-3 rounded-lg" aria-label="Toggle dark mode">Theme</button>
        <button id="signout-btn" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-xs font-semibold py-2 px-4 rounded-lg">Sign Out</button>
      </div>
    </header>

    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg mb-6 sticky top-4 z-10 grid grid-cols-2 divide-x dark:divide-slate-700 text-center">
      <div>
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Today's Karma</p>
        <p id="daily-karma-score" class="text-4xl font-bold mt-1 score-value">0</p>
      </div>
      <div>
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Total Karma</p>
        <p id="total-karma-score" class="text-4xl font-bold mt-1 score-value">0</p>
      </div>
    </div>

    <p id="gita-quote" class="text-sm text-center text-slate-500 dark:text-slate-400 mt-3 mb-6 italic max-w-xl mx-auto"></p>

    <!-- Tasks -->
    <div id="view-tasks">
      <div id="task-list-container" class="min-h-screen">
        <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Today's Actions</h2>
        <ul id="task-list" class="space-y-4"></ul>
        <button id="add-karma-btn" class="w-full mt-6 bg-indigo-200 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-300 dark:hover:bg-indigo-900 font-semibold py-3 rounded-lg text-sm">+ Add New Action</button>
        <button id="quick-log-vikarma-btn" class="w-full mt-2 bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900 font-semibold py-3 rounded-lg text-sm">Log Vikarma Now</button>
      </div>
    </div>
  </div>

  <!-- ============ Minimal Draggable Pen (opens Journal) ============ -->
  <button id="pen-fab" aria-label="Open journal" title="Journal">
    <!-- simple pen svg -->
    <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.0 1.0 0 0 0 0-1.41l-2.34-2.34a1.0 1.0 0 0 0-1.41 0l-1.82 1.82 3.75 3.75 1.82-1.82z" fill="currentColor"/>
    </svg>
  </button>

  <!-- ===================== Journal Page ===================== -->
  <div id="journal" aria-label="Journal" role="dialog">
    <div class="sheet">
      <header>
        <button id="journal-close" class="px-2 py-1 rounded hover:bg-slate-100" aria-label="Back">‚Üê</button>
        <h3 id="journal-title" class="text-base font-semibold">Today</h3>
        <div class="date-badge relative">
          <span id="journal-date-label" class="text-sm text-slate-700">‚Äî</span>
          <label class="relative inline-flex items-center px-2 py-1 rounded border border-slate-300 hover:bg-slate-50 cursor-pointer" title="Go to date">
            <span>üìÖ</span>
            <input id="journal-date-input" type="date">
          </label>
        </div>
      </header>
      <main>
        <textarea id="journal-text" placeholder="Write your daily journal‚Ä¶"></textarea>
        <aside>
          <div class="head">Previous notes</div>
          <div id="journal-list"></div>
        </aside>
      </main>
    </div>
  </div>

  <!-- Modals -->
  <div id="add-karma-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Add New Action">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full modal-enter">
      <h2 class="text-2xl font-bold mb-4">Add New Action</h2>
      <form id="add-karma-form">
        <div class="mb-4">
          <label for="karma-goal-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Assign to Practice (AbhyƒÅsa)</label>
          <select id="karma-goal-select" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg" required></select>
        </div>
        <input type="text" id="karma-name" placeholder="Action name..." class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg mb-4" required>
        <select id="karma-type" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg mb-4">
          <option value="karma">Karma (Positive Action)</option>
          <option value="vikarma">Vikarma (Negative Action)</option>
        </select>
        <div class="grid grid-cols-2 gap-3 mb-6">
          <div>
            <label class="block text-sm mb-1">Reminder Time</label>
            <input id="karma-remind-at" type="time" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
          </div>
          <div>
            <label class="block text-sm mb-1">Deadline</label>
            <input id="karma-deadline-at" type="time" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
          </div>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancel-add-karma-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
          <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Add Action</button>
        </div>
      </form>
    </div>
  </div>

  <div id="prayashchit-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Prayashchit">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full text-center modal-enter">
      <i class="fas fa-person-praying text-5xl text-amber-600 mb-4" aria-hidden="true"></i>
      <h2 class="text-3xl font-bold">Prayashchit (Penance)</h2>
      <p class="mt-2 mb-6">Your daily Karma is negative. Choose a penance to restore balance for tomorrow:</p>
      <div id="prayashchit-options" class="space-y-3 text-left mb-6"></div>
      <div class="mt-4 pt-4 border-t dark:border-slate-700">
        <input type="text" id="custom-prayashchit-input" placeholder="Or add your own..." class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md mb-2">
        <button id="add-custom-prayashchit-btn" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 rounded-md text-sm">Add Custom Penance</button>
      </div>
      <button id="accept-prayashchit-btn" class="w-full mt-4 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg">Accept &amp; End Day</button>
    </div>
  </div>

  <div id="badge-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Badge">
    <div id="badge-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center modal-enter"></div>
  </div>

  <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Daily Summary">
    <div id="summary-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center modal-enter"></div>
  </div>

  <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Confirmation">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center modal-enter">
      <h2 id="confirm-modal-title" class="text-2xl font-bold mb-4">Are you sure?</h2>
      <p id="confirm-modal-text" class="text-slate-500 dark:text-slate-400 mb-6">This action cannot be undone.</p>
      <div class="flex justify-center space-x-4">
        <button id="confirm-modal-cancel-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
        <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
      </div>
    </div>
  </div>

  <div id="message-box" class="hidden fixed bottom-16 right-5 p-4 text-sm rounded-lg shadow-lg z-50" role="alert"></div>
  <button id="installBtn" type="button">Install Karmyog</button>
  <audio id="fire-sound" src="https://cdn.freesound.org/previews/25/25431_132334-lq.mp3" preload="auto"></audio>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-messaging-compat.js"></script>

  <script>
    function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
    function localDateISO(d=new Date()){return d.toLocaleDateString('en-CA')}

    function setTheme(dark){document.documentElement.classList.toggle('dark',dark);const m=document.querySelector('meta[name="theme-color"]');if(m) m.setAttribute('content',dark?'#0f172a':'#f1f5f9');try{localStorage.setItem('theme',dark?'dark':'light')}catch(e){}}
    (function(){const s=(()=>{try{return localStorage.getItem('theme')}catch(e){return null}})();setTheme(s? s==='dark' : (window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches))})();

    const firebaseConfig={apiKey:"AIzaSyA1YxzDZzzyIuAxjxzo_Vy3d8CLtHoBK44",authDomain:"karmyog.life",projectId:"karmyog-6da5f",storageBucket:"karmyog-6da5f.firebasestorage.app",messagingSenderId:"331203556277",appId:"1:331203556277:web:b087b49debac40eeb6dffc",measurementId:"G-316W8DPVBN"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore(),auth=firebase.auth(),storage=firebase.storage(); let messaging=null;

    const dom={
      authOverlay:document.getElementById('auth-overlay'),
      appContainer:document.getElementById('app-container'),
      googleSigninBtn:document.getElementById('google-signin-btn'),
      googleRedirectFallback:document.getElementById('google-redirect-fallback'),
      emailSigninBtn:document.getElementById('email-signin-btn'),
      emailSignupBtn:document.getElementById('email-signup-btn'),
      forgotPasswordBtn:document.getElementById('forgot-password-btn'),
      emailInput:document.getElementById('email-input'),
      passwordInput:document.getElementById('password-input'),
      signoutBtn:document.getElementById('signout-btn'),
      themeToggleBtn:document.getElementById('theme-toggle-btn'),
      dailyKarmaScoreEl:document.getElementById('daily-karma-score'),
      totalKarmaScoreEl:document.getElementById('total-karma-score'),
      gitaQuoteEl:document.getElementById('gita-quote'),
      taskList:document.getElementById('task-list'),
      resetDayBtn:document.getElementById('reset-day-btn'),
      resetKarmaBtn:document.getElementById('reset-karma-btn'),
      sidebar:document.getElementById('sidebar'),
      sidebarOverlay:document.getElementById('sidebar-overlay'),
      menuBtn:document.getElementById('menu-btn'),
      sidebarGoalList:document.getElementById('sidebar-goal-list'),
      sidebarBadgeContainer:document.getElementById('sidebar-badge-container'),
      addGoalBtn:document.getElementById('add-goal-btn'),
      goalNameInput:document.getElementById('goal-name-input'),
      addKarmaModal:document.getElementById('add-karma-modal'),
      addKarmaForm:document.getElementById('add-karma-form'),
      cancelAddKarmaBtn:document.getElementById('cancel-add-karma-btn'),
      addKarmaBtn:document.getElementById('add-karma-btn'),
      karmaGoalSelect:document.getElementById('karma-goal-select'),
      prayashchitModal:document.getElementById('prayashchit-modal'),
      prayashchitOptionsEl:document.getElementById('prayashchit-options'),
      acceptPrayashchitBtn:document.getElementById('accept-prayashchit-btn'),
      customPrayashchitInput:document.getElementById('custom-prayashchit-input'),
      addCustomPrayashchitBtn:document.getElementById('add-custom-prayashchit-btn'),
      fireSound:document.getElementById('fire-sound'),
      badgeModal:document.getElementById('badge-modal'),
      badgeModalContent:document.getElementById('badge-modal-content'),
      summaryModal:document.getElementById('summary-modal'),
      summaryModalContent:document.getElementById('summary-modal-content'),
      confirmModal:document.getElementById('confirm-modal'),
      confirmModalTitle:document.getElementById('confirm-modal-title'),
      confirmModalText:document.getElementById('confirm-modal-text'),
      confirmModalCancelBtn:document.getElementById('confirm-modal-cancel-btn'),
      confirmModalConfirmBtn:document.getElementById('confirm-modal-confirm-btn'),
      remindersToggle:document.getElementById('toggle-inapp-reminders'),
      pushToggle:document.getElementById('toggle-push-reminders'),
      endDayTimeInput:document.getElementById('endday-time'),
      autoFinalizeInput:document.getElementById('auto-finalize-mins'),
      // Journal UI
      penFab:document.getElementById('pen-fab'),
      journal:document.getElementById('journal'),
      journalClose:document.getElementById('journal-close'),
      journalTitle:document.getElementById('journal-title'),
      journalDateLabel:document.getElementById('journal-date-label'),
      journalDateInput:document.getElementById('journal-date-input'),
      journalText:document.getElementById('journal-text'),
      journalList:document.getElementById('journal-list')
    };

    const makeId=()=> (crypto&&crypto.randomUUID? crypto.randomUUID(): `${Date.now()}-${Math.random()}`);
    let state={},unsubscribe,pendingFinalDailyKarma=null,confirmAction=null;

    const defaultState={totalKarma:0,dailyKarma:0,goals:[],unlockedBadges:[],dailyActions:[],customPrayashchits:[],settings:{endDayTime:"22:30",autoFinalizeAfterMins:30,remindersEnabled:true,pushRemindersEnabled:false},lastFinalizedDate:null,metrics:{completedPositiveToday:0,loggedNegativeToday:0}};

    const badges=[{days:9,name:'Arjuna',icon:'fa-user-graduate',color:'text-slate-500',meaning:'The focused warrior, beginning the path.'},{days:18,name:'Sthitapraj√±a',icon:'fa-brain',color:'text-sky-500',meaning:'One of steady wisdom, undisturbed by dualities.'},{days:27,name:'Yuktah',icon:'fa-link',color:'text-blue-500',meaning:'One who is linked in yoga, harmonious.'},{days:36,name:'Niyatam',icon:'fa-calendar-check',color:'text-indigo-500',meaning:'One who performs prescribed duties consistently.'},{days:45,name:'AkartƒÅ',icon:'fa-hand-paper',color:'text-purple-500',meaning:'The non-doer, realizing the self is not the agent.'},{days:54,name:'TyƒÅgƒ´',icon:'fa-leaf',color:'text-emerald-500',meaning:'The renouncer of the fruits of action.'},{days:63,name:'Samatvam',icon:'fa-scale-balanced',color:'text-lime-500',meaning:'One who maintains equanimity in success and failure.'},{days:72,name:'Bhakta',icon:'fa-heart',color:'text-rose-500',meaning:'A devoted soul, connected with love.'},{days:81,name:'J√±ƒÅnƒ´',icon:'fa-book-open',color:'text-amber-500',meaning:'One who possesses true knowledge.'},{days:90,name:'Yogƒ´',icon:'fa-star',color:'text-orange-500',meaning:'A master of the self, united with the divine.'},{days:99,name:'Brahmabh≈´ta',icon:'fa-star-of-life',color:'text-yellow-400',meaning:'One who has attained the Brahman platform.'},{days:108,name:'ƒÄtmarƒÅma',icon:'fa-sun',color:'text-yellow-300',meaning:'One who rejoices in the Self.'}];

    const gitaQuotes=["You have a right to perform your prescribed duties, but you are not entitled to the fruits of your actions. - 2.47","Perform your obligatory duty, because action is indeed better than inaction. - 3.8","The wise see inaction in action and action in inaction. - 4.18","One who performs their duty without attachment, surrendering the results to the Supreme Lord, is unaffected by sinful action. - 5.10","It is better to live your own destiny imperfectly than to live an imitation of somebody else's life with perfection. - 3.35"];
    const prayashchitList=["Take a cold water bath","Avoid all sugar for 24 hours","Use stairs instead of the lift","30 minutes of selfless service (seva)","Maintain silence for 2 hours"];

    /* ===================== Auth / State ===================== */
    auth.onAuthStateChanged(user=>{
      if(user){dom.authOverlay.classList.add('hidden');dom.appContainer.classList.remove('hidden');loadState(user.uid);}
      else{dom.authOverlay.classList.remove('hidden');dom.appContainer.classList.add('hidden');if(unsubscribe) unsubscribe();state={};}
    });

    auth.getRedirectResult().then((r)=>{if(r.user){showMessage(`Welcome, ${r.user.displayName||'friend'}!`,'success')}}).catch((e)=>{if(e.code!=='auth/no-auth-event'){showMessage(e.message,'error')}});

    function loadState(userId){
      const docRef=db.collection('users').doc(userId);
      unsubscribe=docRef.onSnapshot(doc=>{
        state=doc.exists? doc.data(): JSON.parse(JSON.stringify(defaultState));
        if(!state.dailyActions) state.dailyActions=[];
        if(!state.goals) state.goals=[];
        if(!state.customPrayashchits) state.customPrayashchits=[];
        if(!state.settings) state.settings=JSON.parse(JSON.stringify(defaultState.settings));
        if(!state.metrics) state.metrics={completedPositiveToday:0,loggedNegativeToday:0};
        state.goals.forEach(g=>{if(g.totalPracticeKarma===undefined) g.totalPracticeKarma=0;if(g.completedOneToday===undefined) g.completedOneToday=false;if(g.hadTasksToday===undefined) g.hadTasksToday=false;});
        if(!doc.exists) saveState();
        renderAll();
        maybeFinalizeMissedDay();
        scheduleForegroundReminders();
      });
    }

    function saveState(){ if(auth.currentUser){db.collection('users').doc(auth.currentUser.uid).set(state,{merge:true}).catch(console.error)} }
    function clearField(field){
      state[field]=null;
      const uid=auth.currentUser?.uid;
      if(uid){ db.collection('users').doc(uid).set({[field]:firebase.firestore.FieldValue.delete()},{merge:true}).catch(console.error); }
    }

    function renderAll(){ if(!state.goals) return; renderSidebar(); renderTaskList(); updateStats(); initSettingsUI(); showGitaQuoteOnce(); }

    /* ===================== Sidebar / Tasks (unchanged) ===================== */
    function renderSidebar(){
      dom.sidebarGoalList.innerHTML='';
      if(state.goals.length>0){
        state.goals.forEach(goal=>{
          const goalIdStr=String(goal.id);
          dom.sidebarGoalList.innerHTML+=`
            <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
              <span class="font-semibold">${esc(goal.name)}</span>
              <div class="text-right flex-shrink-0 ml-2">
                <p class="font-bold text-sm">SƒÅtatya: ${goal.satatya||0}</p>
                <p class="text-xs text-slate-400">Karma: ${goal.totalPracticeKarma||0}</p>
              </div>
              <button class="delete-goal-btn text-slate-400 hover:text-red-500 ml-2" data-goal-id="${goalIdStr}" aria-label="Delete practice"><i class="fas fa-trash"></i></button>
            </div>`;
        });
      }else{
        dom.sidebarGoalList.innerHTML=`<p class="text-sm text-slate-500 italic">Create your first practice above.</p>`;
      }
      renderBadges();
    }

    function renderTaskList(){
      dom.taskList.innerHTML='';
      if(state.dailyActions.length===0){
        dom.taskList.innerHTML=`<p class="text-center text-slate-500 italic py-8">A fresh start. Add your actions for today.</p>`;
        return;
      }
      state.dailyActions.sort((a,b)=>(a.order||0)-(b.order||0)).forEach(task=>{
        const li=document.createElement('li');
        li.className='karma-item bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md';
        li.dataset.id=String(task.id); li.draggable=true;
        const goal=state.goals.find(g=>String(g.id)===String(task.goalId));
        const goalName=goal?goal.name:'Penance';
        const deleteBtnHTML=`<button class="delete-task-btn text-slate-400 hover:text-red-500 text-xs ml-2" aria-label="Delete action"><i class="fas fa-times"></i></button>`;
        const safeName=esc(task.name), safeGoalName=esc(goalName);
        const timing=(task.remindAt||task.deadlineAt)?`<div class="text-[11px] text-slate-400 mt-1">${task.remindAt?`üîî ${task.remindAt}`:''} ${task.deadlineAt?`‚Ä¢ ‚è∞ ${task.deadlineAt}`:''}</div>`:'';
        if(task.type==='prayashchit'){
          li.classList.add('prayashchit-card');
          li.innerHTML=`<div class="flex items-center"><i class="fas fa-person-praying text-amber-500 mr-4" aria-hidden="true"></i><div><p class="font-semibold text-lg">${safeName}</p><p class="text-xs text-slate-400">Prayashchit (from yesterday)</p>${timing}</div></div>`;
        }else if(task.type==='karma'){
          li.innerHTML=`<div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-leaf text-green-500 mr-4" aria-hidden="true"></i>
              <div><p class="font-semibold text-lg">${safeName}</p><p class="text-xs text-slate-400">${safeGoalName}</p>${timing}</div>
            </div>
            <div class="flex items-center"><span class="font-bold text-green-500 mx-2">+1</span>${deleteBtnHTML}</div></div>`;
        }else{
          li.classList.add('vikarma-card');
          li.innerHTML=`<div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-leaf text-slate-400 mr-4" aria-hidden="true"></i>
              <div><p class="font-semibold text-lg">${safeName}</p><p class="text-xs text-slate-400">${safeGoalName}</p></div>
            </div>
            <div class="flex items-center"><span class="font-bold text-red-500">-1</span><button class="log-vikarma-btn text-xs bg-red-500 text-white px-3 py-1 rounded-md mx-2" aria-label="Log negative action">Log</button>${deleteBtnHTML}</div></div>`;
        }
        dom.taskList.appendChild(li);
      });
    }

    function renderBadges(){
      dom.sidebarBadgeContainer.innerHTML='';
      badges.forEach(b=>{
        const unlocked=Array.isArray(state.unlockedBadges)&&state.unlockedBadges.includes(b.name);
        const el=document.createElement('div');
        el.className=`badge p-2 rounded-lg cursor-pointer ${unlocked?'unlocked':'locked'}`;
        el.title=unlocked?`${b.name} - Unlocked!`:`${b.name} - Locked`;
        el.dataset.badgeName=b.name;
        el.innerHTML=`<i class="fas ${b.icon} text-3xl ${unlocked?b.color:'text-slate-400'}" aria-hidden="true"></i>`;
        dom.sidebarBadgeContainer.appendChild(el);
      });
    }

    function updateStats(){
      animateValue(dom.dailyKarmaScoreEl,state.dailyKarma||0);
      animateValue(dom.totalKarmaScoreEl,state.totalKarma||0);
      [dom.dailyKarmaScoreEl,dom.totalKarmaScoreEl].forEach(el=>{
        const v=parseInt(el.textContent)||0;
        el.classList.remove('karma-positive','karma-negative','karma-neutral');
        if(v>0) el.classList.add('karma-positive');
        else if(v<0) el.classList.add('karma-negative');
        else el.classList.add('karma-neutral');
      });
    }

    /* ===================== Daily flow (unchanged) ===================== */
    function endDay(){
      let finalDailyKarma=state.dailyKarma||0;
      const missed=state.dailyActions.filter(t=>t.type==='karma');
      missed.forEach(()=>{finalDailyKarma-=1;});
      state.goals.forEach(goal=>{
        if(goal.hadTasksToday&&goal.completedOneToday){
          goal.satatya=(goal.satatya||0)+1;
          badges.forEach(b=>{
            if(goal.satatya>=b.days&&(!state.unlockedBadges||!state.unlockedBadges.includes(b.name))){
              state.unlockedBadges=state.unlockedBadges||[]; state.unlockedBadges.push(b.name);
              setTimeout(()=>showBadgeUnlockModal(b),500);
            }
          });
        }else if(goal.hadTasksToday){goal.satatya=0;}
      });
      pendingFinalDailyKarma=finalDailyKarma;
      showSummaryModal(finalDailyKarma,missed.length);
    }

    function finalizeDay(finalDailyKarma,prayashchitChoice=null){
      state.totalKarma=(state.totalKarma||0)+finalDailyKarma;
      state.dailyKarma=0; state.dailyActions=[];
      state.metrics={completedPositiveToday:0,loggedNegativeToday:0};
      state.goals.forEach(g=>{g.hadTasksToday=false;g.completedOneToday=false;});
      if(prayashchitChoice){
        state.dailyActions.push({id:makeId(),name:prayashchitChoice,type:'prayashchit',goalId:null,order:0});
      }
      pendingFinalDailyKarma=null;
      state.lastFinalizedDate=localDateISO();
      saveState();
    }

    /* ===================== Drag & drop list (unchanged) ===================== */
    let draggedItem=null;
    dom.taskList.addEventListener('dragstart',e=>{ if(e.target.classList.contains('karma-item')){draggedItem=e.target; setTimeout(()=>e.target.classList.add('dragging'),0);} });
    dom.taskList.addEventListener('dragover',e=>{
      e.preventDefault();
      const rect=dom.taskList.getBoundingClientRect(), y=e.clientY;
      if(y<rect.top+50){window.scrollBy(0,-15)} else if(y>rect.bottom-50){window.scrollBy(0,15)}
      const after=getDragAfterElement(dom.taskList,y);
      if(after==null){dom.taskList.appendChild(draggedItem)} else {dom.taskList.insertBefore(draggedItem,after)}
    });
    dom.taskList.addEventListener('dragend',()=>{
      if(draggedItem){draggedItem.classList.remove('dragging');draggedItem=null;
        const order=[...dom.taskList.querySelectorAll('.karma-item')].map(i=>String(i.dataset.id));
        state.dailyActions.forEach(t=>{t.order=order.indexOf(String(t.id));}); saveState();
      }
    });
    function getDragAfterElement(container,y){
      const els=[...container.querySelectorAll('.karma-item:not(.dragging)')];
      return els.reduce((c,child)=>{const b=child.getBoundingClientRect();const off=y-b.top-b.height/2;if(off<0&&off>c.offset){return{offset:off,element:child}}else{return c}}, {offset:Number.NEGATIVE_INFINITY}).element;
    }

    /* ===================== Toasters, helpers ===================== */
    function showMessage(message,type='success'){
      const box=document.getElementById('message-box');
      box.textContent=message;
      box.className='fixed bottom-16 right-5 p-4 text-sm rounded-lg shadow-lg z-50 ';
      if(type==='success') box.classList.add('bg-green-100','dark:bg-green-900','text-green-800','dark:text-green-200');
      else if(type==='error') box.classList.add('bg-red-100','dark:bg-red-900','text-red-800','dark:text-red-200');
      else box.classList.add('bg-blue-100','dark:bg-blue-900','text-blue-800','dark:text-blue-200');
      box.classList.remove('hidden'); setTimeout(()=>box.classList.add('hidden'),3000);
    }
    function animateValue(el,target){const start=parseInt(el.textContent.replace(/,/g,''))||0; if(start===target){el.textContent=target;return;}
      const dur=300; let t0=null; const step=(t)=>{if(!t0) t0=t; const p=Math.min((t-t0)/dur,1); el.textContent=Math.floor(p*(target-start)+start); if(p<1) requestAnimationFrame(step)}; requestAnimationFrame(step);
    }

    function showBadgeUnlockModal(b){
      const c=document.getElementById('badge-modal-content');
      c.innerHTML=`
        <i class="fas ${b.icon} text-6xl mb-4 ${b.color} badge-ceremony-icon" aria-hidden="true"></i>
        <h2 class="text-3xl font-bold">Badge Unlocked!</h2>
        <p class="text-xl mt-2">${esc(b.name)}</p>
        <p class="text-slate-500 dark:text-slate-400 mt-2 italic">"${esc(b.meaning)}"</p>
        <button onclick="document.getElementById('badge-modal').classList.add('hidden')" class="mt-6 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold py-2 px-6 rounded-lg">Continue</button>`;
      document.getElementById('badge-modal').classList.remove('hidden');
    }
    function showBadgeInfoModal(b){
      const c=document.getElementById('badge-modal-content');
      c.innerHTML=`
        <i class="fas ${b.icon} text-6xl mb-4 text-slate-400" aria-hidden="true"></i>
        <h2 class="text-3xl font-bold">${esc(b.name)}</h2>
        <p class="text-slate-500 dark:text-slate-400 mt-2">Requires ${b.days} days of SƒÅtatya in a single practice to unlock.</p>
        <p class="text-slate-500 dark:text-slate-400 mt-2 italic">"${esc(b.meaning)}"</p>
        <button onclick="document.getElementById('badge-modal').classList.add('hidden')" class="mt-6 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold py-2 px-6 rounded-lg">Close</button>`;
      document.getElementById('badge-modal').classList.remove('hidden');
    }

    function showSummaryModal(finalDailyKarma,missedCount,opts={}){
      const title=opts.title||'Day Complete';
      const earned=(opts.earned!=null)?opts.earned:(state.metrics?.completedPositiveToday||0);
      const negatives=(opts.negatives!=null)?opts.negatives:(state.metrics?.loggedNegativeToday||0);
      const planned=earned+(missedCount||0);
      const c=document.getElementById('summary-modal-content');
      c.innerHTML=`
        <h2 class="text-3xl font-bold">${esc(title)}</h2>
        <div class="mt-4 text-left bg-slate-100 dark:bg-slate-700 rounded-lg p-4">
          <div class="flex justify-between"><span>Planned (positive)</span><span class="font-semibold">${planned}</span></div>
          <div class="flex justify-between mt-1"><span>Earned (done)</span><span class="font-semibold karma-positive">+${earned}</span></div>
          <div class="flex justify-between mt-1"><span>Missed (penalty)</span><span class="font-semibold karma-negative">-${missedCount||0}</span></div>
          <div class="flex justify-between mt-1"><span>Negatives logged</span><span class="font-semibold karma-negative">-${negatives}</span></div>
          <hr class="my-3 border-slate-300 dark:border-slate-600">
          <div class="flex justify-between text-lg">
            <span>Final Karma</span>
            <span class="font-bold ${finalDailyKarma>=0?'karma-positive':'karma-negative'}">${finalDailyKarma>0?'+':''}${finalDailyKarma}</span>
          </div>
        </div>
        <button id="close-summary-btn" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg">Continue</button>`;
      document.getElementById('summary-modal').classList.remove('hidden');
      document.getElementById('close-summary-btn').onclick=()=>{
        document.getElementById('summary-modal').classList.add('hidden');
        if(typeof opts.onContinue==='function'){opts.onContinue();return;}
        if(finalDailyKarma<0){
          renderPrayashchitOptions();
          document.getElementById('prayashchit-modal').classList.remove('hidden');
          setPrayashchitHandler(()=>{
            const selected=document.querySelector('input[name="prayashchit"]:checked');
            const choice=selected?selected.value:null;
            document.getElementById('prayashchit-modal').classList.add('hidden'); finalizeDay(finalDailyKarma,choice);
          });
        }else{finalizeDay(finalDailyKarma);}
      };
    }

    function renderPrayashchitOptions(){
      const all=[...prayashchitList,...(state.customPrayashchits||[])];
      const el=document.getElementById('prayashchit-options');
      el.innerHTML='';
      [...all].sort(()=>.5-Math.random()).slice(0,3).forEach((p,i)=>{
        const s=esc(p);
        el.innerHTML+=`<label class="flex items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"><input type="radio" name="prayashchit" value="${s}" class="mr-3" ${i===0?'checked':''}>${s}</label>`;
      });
    }
    function setPrayashchitHandler(fn){ document.getElementById('accept-prayashchit-btn').onclick=null; document.getElementById('accept-prayashchit-btn').onclick=fn; }

    function initSettingsUI(){ const s=state.settings||defaultState.settings;
      document.getElementById('toggle-inapp-reminders').checked=!!s.remindersEnabled;
      document.getElementById('toggle-push-reminders').checked=!!s.pushRemindersEnabled;
      document.getElementById('endday-time').value=s.endDayTime||"22:30";
      document.getElementById('auto-finalize-mins').value=s.autoFinalizeAfterMins??30;
    }
    function bindSettingsEvents(){
      document.getElementById('toggle-inapp-reminders').addEventListener('change',()=>{state.settings.remindersEnabled=document.getElementById('toggle-inapp-reminders').checked; saveState();});
      document.getElementById('toggle-push-reminders').addEventListener('change',async ()=>{
        const el=document.getElementById('toggle-push-reminders');
        if(el.checked){ const ok=await ensurePushPermission(); state.settings.pushRemindersEnabled=!!ok; el.checked=!!ok; }
        else{ state.settings.pushRemindersEnabled=false; }
        saveState();
      });
      document.getElementById('endday-time').addEventListener('change',()=>{state.settings.endDayTime=document.getElementById('endday-time').value||"22:30"; saveState();});
      document.getElementById('auto-finalize-mins').addEventListener('change',()=>{const v=parseInt(document.getElementById('auto-finalize-mins').value,10); state.settings.autoFinalizeAfterMins=isNaN(v)?30:Math.max(5,v); saveState();});
    }
    bindSettingsEvents();

    let schedulerTimer=null,alreadyReminded=new Set();
    function scheduleForegroundReminders(){ if(schedulerTimer) clearInterval(schedulerTimer); schedulerTimer=setInterval(checkDueReminders,30*1000); checkDueReminders(); }
    function parseHM(hm){ if(!hm) return null; const [h,m]=hm.split(':').map(Number); const d=new Date(); d.setHours(h||0,m||0,0,0); return d; }
    function markKey(id,kind){ return `${id}:${kind}:${new Date().toDateString()}`; }
    async function checkDueReminders(){
      const s=state.settings||{}; if(!s.remindersEnabled) return; const now=Date.now();
      (state.dailyActions||[]).forEach(t=>{
        if(t.type!=='karma') return;
        const r=parseHM(t.remindAt); if(!r) return;
        const key=markKey(t.id,'remind');
        if(!alreadyReminded.has(key)&&Math.abs(now-r.getTime())<60*1000){alreadyReminded.add(key); vibrateSoft(); showMessage(`Reminder: ${t.name}`,'info'); maybeNotify(`Reminder: ${t.name}`,`Do it before ${t.deadlineAt||'deadline'}`);}
      });
      const edt=parseHM((state.settings||{}).endDayTime);
      if(edt){
        const endKey=markKey('endday','remind');
        if(!alreadyReminded.has(endKey)&&Math.abs(now-edt.getTime())<60*1000){
          alreadyReminded.add(endKey); vibrateSoft(); showMessage('Time to wrap up your day. Review & complete tasks.','info'); maybeNotify('Day Wrap-Up','Review today‚Äôs tasks now.');
          state._autoFinalizeAt=edt.getTime()+(state.settings.autoFinalizeAfterMins||30)*60*1000; saveState();
        }
        const todayLocal=localDateISO();
        if(state.lastFinalizedDate!==todayLocal&&state._autoFinalizeAt&&now>=state._autoFinalizeAt){
          const missed=state.dailyActions.filter(t=>t.type==='karma');
          let finalDailyKarma=(state.dailyKarma||0)-missed.length;
          finalizeDay(finalDailyKarma);
          state.lastFinalizedDate=todayLocal; clearField('_autoFinalizeAt'); saveState();
          showMessage('Day auto-finalized.','success'); maybeNotify('Day finalized',`Final karma: ${finalDailyKarma>=0?'+':''}${finalDailyKarma}`);
        }
      }
    }
    function vibrateSoft(){try{if(navigator.vibrate) navigator.vibrate([30,30,30]);}catch(e){}}
    async function maybeNotify(title,body){
      try{ if(!('Notification' in window)) return;
        if(Notification.permission==='granted'){ const reg=await navigator.serviceWorker.getRegistration(); if(reg) reg.showNotification(title,{body,icon:'/icons/icon-192x192.png'}); else new Notification(title,{body}); }
      }catch(e){}
    }

    function maybeFinalizeMissedDay(){
      const todayLocal=localDateISO();
      if(state.lastFinalizedDate!==todayLocal){
        const missed=state.dailyActions.filter(t=>t.type==='karma');
        let finalDailyKarma=(state.dailyKarma||0)-missed.length;
        finalizeDay(finalDailyKarma); state.lastFinalizedDate=todayLocal; saveState(); showMessage('Finalized previous day on resume.','info');
      }
    }

    async function ensurePushPermission(){
      try{
        if(!('Notification' in window)){showMessage('Notifications not supported on this device.','error');return false;}
        const perm=await Notification.requestPermission(); if(perm!=='granted'){showMessage('Notifications permission denied.','error');return false;}
        if(!messaging) messaging=firebase.messaging();
        const reg=await navigator.serviceWorker.ready;
        const token=await messaging.getToken({vapidKey:'BCoF7_yJ4AcT_dyf98XjeZ8H8X3IxRmynPLGddqOsj6TcSO5Xni5Bx7nYS1FOZDzG1f03VPJ6JUXUqZ2yd_GpFs',serviceWorkerRegistration:reg});
        const uid=auth.currentUser?.uid; if(uid&&token) await db.collection('users').doc(uid).set({fcmToken:token},{merge:true});
        showMessage('Push reminders enabled.','success'); return true;
      }catch(e){console.error(e);showMessage(e.message||'Push set-up failed.','error');return false;}
    }

    /* ===================== Minimal Journal Implementation ===================== */
    const JOURNAL_LOCAL_KEY='journal-local';
    function isoToday(){ return new Date().toLocaleDateString('en-CA'); }

    // Draggable + persist position
    (function initPenDrag(){
      const btn=dom.penFab;
      // restore position
      try{
        const saved=JSON.parse(localStorage.getItem('pen-pos')||'null');
        if(saved && typeof saved.x==='number' && typeof saved.y==='number'){
          btn.style.left=saved.x+'px'; btn.style.top=saved.y+'px';
          btn.style.right='auto'; btn.style.bottom='auto';
        }
      }catch(e){}
      let drag=null;
      function onStart(ev){
        const p=('touches' in ev)? ev.touches[0] : ev;
        const rect=btn.getBoundingClientRect();
        drag={startX:p.clientX, startY:p.clientY, originX:rect.left, originY:rect.top};
        ev.preventDefault();
      }
      function onMove(ev){
        if(!drag) return;
        const p=('touches' in ev)? ev.touches[0] : ev;
        let x=drag.originX + (p.clientX - drag.startX);
        let y=drag.originY + (p.clientY - drag.startY);
        const w=window.innerWidth, h=window.innerHeight;
        x=Math.max(8, Math.min(x, w-52)); y=Math.max(8, Math.min(y, h-52));
        btn.style.left=x+'px'; btn.style.top=y+'px';
        btn.style.right='auto'; btn.style.bottom='auto';
      }
      function onEnd(){
        if(!drag) return;
        const rect=btn.getBoundingClientRect();
        const snapLeft = rect.left < window.innerWidth/2;
        const x = snapLeft ? 12 : window.innerWidth - rect.width - 12;
        const y = Math.max(8, Math.min(rect.top, window.innerHeight - rect.height - 8));
        btn.style.left=x+'px'; btn.style.top=y+'px';
        btn.style.right='auto'; btn.style.bottom='auto';
        try{localStorage.setItem('pen-pos', JSON.stringify({x,y}));}catch(e){}
        drag=null;
      }
      btn.addEventListener('mousedown',onStart);
      window.addEventListener('mousemove',onMove);
      window.addEventListener('mouseup',onEnd);
      btn.addEventListener('touchstart',onStart,{passive:false});
      window.addEventListener('touchmove',onMove,{passive:false});
      window.addEventListener('touchend',onEnd);
    })();

    // Open / close journal
    dom.penFab.addEventListener('click',()=>openJournal());
    dom.journalClose.addEventListener('click',()=>closeJournal());
    function openJournal(dateStr){
      const d=dateStr || isoToday();
      dom.journal.classList.add('show');
      document.body.style.overflow='hidden';
      setJournalDate(d);
      loadJournalList();
      loadJournalContent(d);
    }
    function closeJournal(){
      dom.journal.classList.remove('show');
      document.body.style.overflow='';
    }

    // Date navigation
    dom.journalDateInput.addEventListener('change', (e)=> {
      const d=e.target.value || isoToday();
      setJournalDate(d);
      loadJournalContent(d);
    });

    function setJournalDate(dateStr){
      dom.journalDateInput.value=dateStr;
      dom.journalDateLabel.textContent=new Date(dateStr).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
      dom.journalTitle.textContent = dateStr===isoToday()? 'Today' : dateStr;
    }

    // Autosave (Firestore if signed in, else local)
    let saveTimer=null;
    dom.journalText.addEventListener('input',()=>{
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer=setTimeout(()=>saveCurrentJournal(),500);
    });

    async function saveCurrentJournal(){
      const date=dom.journalDateInput.value || isoToday();
      const content=dom.journalText.value;
      const uid=auth.currentUser?.uid;
      try{
        if(uid){
          await db.collection('users').doc(uid).collection('journal').doc(date).set({
            content, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge:true });
        }else{
          const map=JSON.parse(localStorage.getItem(JOURNAL_LOCAL_KEY)||'{}');
          map[date]={content, updatedAt: Date.now()};
          localStorage.setItem(JOURNAL_LOCAL_KEY, JSON.stringify(map));
        }
        // update list preview quickly
        upsertListItem(date, content);
      }catch(e){ console.error(e); showMessage('Failed to save note','error'); }
    }

    // Load content for a given date
    async function loadJournalContent(date){
      const uid=auth.currentUser?.uid;
      if(uid){
        try{
          const doc=await db.collection('users').doc(uid).collection('journal').doc(date).get();
          const content=doc.exists? (doc.data().content||'') : '';
          dom.journalText.value = content;
        }catch(e){ console.error(e); dom.journalText.value=''; }
      }else{
        const map=JSON.parse(localStorage.getItem(JOURNAL_LOCAL_KEY)||'{}');
        dom.journalText.value = map[date]?.content || '';
      }
    }

    // Load previous list (last 90 days by default)
    async function loadJournalList(){
      const uid=auth.currentUser?.uid;
      const listEl=dom.journalList;
      listEl.innerHTML='';
      if(uid){
        try{
          const snap=await db.collection('users').doc(uid).collection('journal').orderBy('updatedAt','desc').limit(120).get();
          if(snap.empty){ listEl.innerHTML='<p class="px-3 py-3 text-slate-500 italic">No notes yet.</p>'; return; }
          snap.forEach(d=>{
            const date=d.id, content=(d.data().content||'').trim();
            addListItem(date, content);
          });
        }catch(e){ console.error(e); listEl.innerHTML='<p class="px-3 py-3 text-red-500">Failed to load notes.</p>'; }
      }else{
        const map=JSON.parse(localStorage.getItem(JOURNAL_LOCAL_KEY)||'{}');
        const entries=Object.entries(map).sort((a,b)=> (b[0]).localeCompare(a[0]));
        if(!entries.length){ listEl.innerHTML='<p class="px-3 py-3 text-slate-500 italic">No notes yet.</p>'; return; }
        entries.forEach(([date,rec])=> addListItem(date, (rec.content||'').trim()));
      }
    }
    function addListItem(date, content){
      const btn=document.createElement('button');
      btn.className='note-item';
      btn.innerHTML=`<div class="date">${esc(date)}</div><div class="preview">${esc(content||'(empty)')}</div>`;
      btn.addEventListener('click',()=>{ setJournalDate(date); loadJournalContent(date); });
      dom.journalList.appendChild(btn);
    }
    function upsertListItem(date, content){
      const all=[...dom.journalList.querySelectorAll('.note-item')];
      const existing=all.find(b=>b.querySelector('.date')?.textContent===date);
      if(existing){
        existing.querySelector('.preview').textContent=content||'(empty)';
        // move to top
        dom.journalList.prepend(existing);
      }else{
        addListItem(date, content);
        // keep recent first
        const items=[...dom.journalList.children];
        items.sort((a,b)=> b.querySelector('.date').textContent.localeCompare(a.querySelector('.date').textContent));
        items.forEach(i=>dom.journalList.appendChild(i));
      }
    }

    /* ===================== Misc UI binds ===================== */
    function showGitaQuoteOnce(){ const q=gitaQuotes[Math.floor(Math.random()*gitaQuotes.length)]; dom.gitaQuoteEl.textContent=q; }
    function openConfirmModal(title,text,onConfirm){
      document.getElementById('confirm-modal-title').textContent=title;
      document.getElementById('confirm-modal-text').textContent=text;
      document.getElementById('confirm-modal').classList.remove('hidden');
      confirmAction=onConfirm;
    }
    document.getElementById('confirm-modal-cancel-btn').addEventListener('click',()=>document.getElementById('confirm-modal').classList.add('hidden'));
    document.getElementById('confirm-modal-confirm-btn').addEventListener('click',()=>{ if(typeof confirmAction==='function'){confirmAction();} document.getElementById('confirm-modal').classList.add('hidden'); });

    function handleTaskClick(e){
      const fireOverlay=e.target.closest('.fire-overlay');
      const logVikarmaBtn=e.target.closest('.log-vikarma-btn');
      const deleteBtn=e.target.closest('.delete-task-btn');
      if(fireOverlay){handleKarmaCompletion(e);return;}
      if(logVikarmaBtn){handleVikarmaLog(e);return;}
      if(deleteBtn){handleDeleteTask(e);return;}
      const item=e.target.closest('.karma-item'); if(!item) return;
      const task=state.dailyActions.find(t=>String(t.id)===String(item.dataset.id));
      if(!task||task.type==='vikarma'||task.type==='prayashchit') return;
      document.querySelectorAll('.fire-overlay').forEach(el=>{if(el.parentElement!==item) el.remove();});
      if(item.querySelector('.fire-overlay')){item.querySelector('.fire-overlay').remove();}
      else{
        const o=document.createElement('div');o.className='fire-overlay';o.innerHTML=`<i class="fas fa-fire text-orange-500 text-4xl" aria-hidden="true"></i>`;item.appendChild(o);
      }
    }
    function handleKarmaCompletion(e){
      const item=e.target.closest('.karma-item'); if(!item) return;
      const id=String(item.dataset.id);
      const idx=state.dailyActions.findIndex(t=>String(t.id)===id); if(idx===-1) return;
      const task=state.dailyActions[idx];
      const goal=state.goals.find(g=>String(g.id)===String(task.goalId));
      state.dailyKarma=(state.dailyKarma||0)+1;
      state.metrics.completedPositiveToday=(state.metrics.completedPositiveToday||0)+1;
      if(goal){goal.totalPracticeKarma=(goal.totalPracticeKarma||0)+1;goal.completedOneToday=true;}
      state.dailyActions.splice(idx,1);
      try{document.getElementById('fire-sound').currentTime=0;document.getElementById('fire-sound').play().catch(()=>{})}catch(e){}
      if(navigator.vibrate) navigator.vibrate(50);
      item.classList.add('completed');
      setTimeout(saveState,500);
    }
    function handleVikarmaLog(e){
      const item=e.target.closest('.karma-item'); if(!item) return;
      const id=String(item.dataset.id);
      const idx=state.dailyActions.findIndex(t=>String(t.id)===id); if(idx===-1) return;
      const task=state.dailyActions[idx];
      const goal=state.goals.find(g=>String(g.id)===String(task.goalId));
      state.dailyKarma=(state.dailyKarma||0)-1;
      state.metrics.loggedNegativeToday=(state.metrics.loggedNegativeToday||0)+1;
      if(goal) goal.totalPracticeKarma=(goal.totalPracticeKarma||0)-1;
      state.dailyActions.splice(idx,1);
      if(navigator.vibrate) navigator.vibrate([100,30,100]);
      item.classList.add('completed');
      setTimeout(saveState,500);
    }
    function handleDeleteTask(e){
      const item=e.target.closest('.karma-item'); if(!item) return;
      const id=String(item.dataset.id);
      const task=state.dailyActions.find(t=>String(t.id)===id);
      if(!task) return;
      if(task.type==='vikarma'){showMessage('Negative actions should be logged, not deleted.','error');return;}
      state.dailyActions=state.dailyActions.filter(t=>String(t.id)!==id);
      showMessage('Action removed.','info'); saveState();
    }

    document.getElementById('google-signin-btn').addEventListener('click',()=>{
      const provider=new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err=>{
        if(['auth/popup-blocked','auth/popup-closed-by-user','auth/cancelled-popup-request'].includes(err.code)){auth.signInWithRedirect(provider);}
        else{showMessage(err.message,'error');}
      });
    });
    document.getElementById('google-redirect-fallback').addEventListener('click',(e)=>{e.preventDefault(); const provider=new firebase.auth.GoogleAuthProvider(); auth.signInWithRedirect(provider);});
    document.getElementById('email-signup-btn').addEventListener('click',()=>{auth.createUserWithEmailAndPassword(dom.emailInput.value,dom.passwordInput.value).catch(e=>showMessage(e.message,'error'));});
    document.getElementById('email-signin-btn').addEventListener('click',()=>{auth.signInWithEmailAndPassword(dom.emailInput.value,dom.passwordInput.value).catch(e=>showMessage(e.message,'error'));});
    document.getElementById('forgot-password-btn').addEventListener('click',async ()=>{
      const email=dom.emailInput.value.trim();
      if(!email){showMessage('Enter your email above first.','error');return;}
      try{await auth.sendPasswordResetEmail(email);showMessage('Password reset email sent.','success');}
      catch(e){showMessage(e.message,'error');}
    });
    document.getElementById('signout-btn').addEventListener('click',()=>auth.signOut());
    document.getElementById('menu-btn').addEventListener('click',()=>toggleSidebar(true));
    document.getElementById('sidebar-overlay').addEventListener('click',()=>toggleSidebar(false));
    document.getElementById('add-goal-btn').addEventListener('click',addGoal);
    document.getElementById('sidebar-goal-list').addEventListener('click',(e)=>{ if(e.target.closest('.delete-goal-btn')){ const goalId=String(e.target.closest('.delete-goal-btn').dataset.goalId); openConfirmModal('Delete Practice?','This will remove the practice and any of its tasks for today. This cannot be undone.',()=>{state.goals=state.goals.filter(g=>String(g.id)!==goalId); state.dailyActions=state.dailyActions.filter(t=>String(t.goalId)!==goalId); showMessage('Practice removed.','info'); saveState();}); }});
    document.getElementById('add-karma-btn').addEventListener('click',openAddKarmaModal);
    document.getElementById('add-karma-form').addEventListener('submit',handleAddKarma);
    document.getElementById('cancel-add-karma-btn').addEventListener('click',()=>document.getElementById('add-karma-modal').classList.add('hidden'));
    document.getElementById('task-list').addEventListener('click',handleTaskClick);
    document.getElementById('reset-day-btn').addEventListener('click',endDay);
    document.getElementById('reset-karma-btn').addEventListener('click',handleResetKarma);
    document.getElementById('sidebar-badge-container').addEventListener('click',e=>{
      const el=e.target.closest('.badge'); if(!el) return;
      const b=badges.find(x=>x.name===el.dataset.badgeName); if(!b) return;
      if(el.classList.contains('unlocked')) showBadgeUnlockModal(b); else showBadgeInfoModal(b);
    });
    document.getElementById('add-custom-prayashchit-btn').addEventListener('click',addCustomPrayashchit);
    document.getElementById('quick-log-vikarma-btn').addEventListener('click',quickLogVikarma);
    document.addEventListener('click',e=>{ if(e.target.id==='badge-modal') document.getElementById('badge-modal').classList.add('hidden'); });
    document.getElementById('theme-toggle-btn').addEventListener('click',()=>setTheme(!document.documentElement.classList.contains('dark')));

    function addGoal(){
      const name=document.getElementById('goal-name-input').value.trim();
      if(!name){showMessage("Practice name cannot be empty.","error");return;}
      state.goals.push({id:makeId(),name,satatya:0,totalPracticeKarma:0,hadTasksToday:false,completedOneToday:false});
      document.getElementById('goal-name-input').value=''; saveState();
    }
    function openAddKarmaModal(){
      if(state.goals.length===0){showMessage("Please create a Practice first.","error");return;}
      document.getElementById('karma-goal-select').innerHTML=state.goals.map(g=>`<option value="${String(g.id)}">${esc(g.name)}</option>`).join('');
      document.getElementById('add-karma-form').reset();
      document.getElementById('add-karma-modal').classList.remove('hidden');
    }
    function handleAddKarma(e){
      e.preventDefault();
      const goalId=String(document.getElementById('karma-goal-select').value);
      const name=document.getElementById('add-karma-form').querySelector('#karma-name').value.trim();
      const type=document.getElementById('add-karma-form').querySelector('#karma-type').value;
      const remindAt=document.getElementById('add-karma-form').querySelector('#karma-remind-at')?.value||null;
      const deadlineAt=document.getElementById('add-karma-form').querySelector('#karma-deadline-at')?.value||null;
      if(!name){showMessage("Action name is required.","error");return;}
      const goal=state.goals.find(g=>String(g.id)===goalId);
      if(goal&&type==='karma'){goal.hadTasksToday=true;}
      state.dailyActions.push({id:makeId(),name,type,goalId,order:state.dailyActions.length,remindAt,deadlineAt});
      document.getElementById('add-karma-modal').classList.add('hidden'); saveState();
    }
    function toggleSidebar(show){ if(show){document.getElementById('sidebar').classList.remove('-translate-x-full');document.getElementById('sidebar-overlay').classList.remove('hidden');} else {document.getElementById('sidebar').classList.add('-translate-x-full');document.getElementById('sidebar-overlay').classList.add('hidden');} }
    function handleResetKarma(){
      openConfirmModal('Reset All Karma?','This will reset your Total Karma and all Practice Karma scores to zero. This cannot be undone.',()=>{
        state.totalKarma=0; state.goals.forEach(g=>g.totalPracticeKarma=0); showMessage('Your accumulated Karma has been reset.','info'); saveState();
      });
    }
  </script>

  <!-- PWA Service Worker and Install Prompt -->
  <script>
    const SW_PATH='./service-worker.js';
    if('serviceWorker' in navigator){
      window.addEventListener('load',async ()=>{
        try{
          const reg=await navigator.serviceWorker.register(SW_PATH);
          if(reg.waiting){reg.waiting.postMessage({type:'SKIP_WAITING'});}
          reg.addEventListener('updatefound',()=>{const nw=reg.installing; if(!nw) return; nw.addEventListener('statechange',()=>{if(nw.state==='installed'&&navigator.serviceWorker.controller){nw.postMessage({type:'SKIP_WAITING'});}});});
          navigator.serviceWorker.addEventListener('controllerchange',()=>{if(!window.__reloadedForSW){window.__reloadedForSW=true; window.location.reload();}});
        }catch(err){console.log('ServiceWorker registration failed: ',err);}
      });
    }
    let deferredPrompt; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault(); deferredPrompt=e; installBtn.style.display='inline-block';});
    installBtn.addEventListener('click',async ()=>{installBtn.style.display='none'; if(deferredPrompt){deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;}});
    window.addEventListener('appinstalled',()=>{installBtn.style.display='none'; deferredPrompt=null;});
  </script>
</body>
</html>
