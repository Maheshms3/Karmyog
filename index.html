<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karmyog - Your Path of Abhyāsa</title>
  <link rel="canonical" href="https://karmyog.life/"/>

  <!-- PWA -->
  <meta name="theme-color" content="#1e293b"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icons/icon-192x192.png"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' }; </script>

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    body{font-family:'Inter',sans-serif;user-select:none;overflow-x:hidden;}
    .karma-item{transition:opacity .5s ease,transform .5s ease;position:relative;}
    .karma-item.completed{opacity:0;transform:scale(.5) translateX(100%);}
    .fire-overlay{position:absolute;inset:0;background:rgba(255,165,0,.1);display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:.75rem;}
    .karma-positive{color:#22c55e}.karma-negative{color:#ef4444}.karma-neutral{color:#64748b}
    .badge{transition:transform .3s ease,filter .3s ease}.badge.unlocked{filter:none}.badge.locked{filter:grayscale(100%) opacity(.4)}.badge:hover{transform:scale(1.1)}
    #sidebar{transition:transform .3s ease-in-out}#sidebar-overlay{transition:opacity .3s ease-in-out}
    .vikarma-card{background-color:#fef2f2}.dark .vikarma-card{background-color:rgba(153,27,27,.2)}
    .prayashchit-card{background-color:#fffbeb}.dark .prayashchit-card{background-color:rgba(180,83,9,.2)}
    .dragging{opacity:.5;cursor:grabbing}.score-value{transition:color .5s ease}
    .modal-enter{animation:fadeIn .3s ease-out forwards}@keyframes fadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    #installBtn{position:fixed;right:1rem;bottom:4.5rem;padding:.7rem 1rem;border:0;border-radius:.6rem;font:600 14px/1.2 system-ui,sans-serif;background:#4f46e5;color:#fff;cursor:pointer;display:none;z-index:100}
    .badge-ceremony-icon{animation:spin-and-glow 1.5s ease-in-out}@keyframes spin-and-glow{0%{transform:scale(.5) rotate(0);filter:drop-shadow(0 0 0 white)}50%{transform:scale(1.2) rotate(360deg);filter:drop-shadow(0 0 15px white)}100%{transform:scale(1) rotate(360deg);filter:drop-shadow(0 0 5px white)}}
    .with-bottom-nav{padding-bottom:0}

    /* ============== Minimal Draggable Pen (opens journal.html) ============== */
    #pen-fab{
      position:fixed; z-index:9999; width:44px; height:44px; border-radius:9999px;
      display:grid; place-items:center; cursor:grab; pointer-events:auto;
      background:rgba(255,255,255,.6);
      border:1px solid rgba(0,0,0,.12);
      box-shadow:0 6px 20px rgba(0,0,0,.15);
      backdrop-filter:saturate(120%) blur(6px);
      right:16px; bottom:16px; color:#0f172a;
      touch-action:none; /* for reliable touch dragging */
    }
    .dark #pen-fab{ background:rgba(2,6,23,.4); border-color:rgba(255,255,255,.12); color:#fff; }
    #pen-fab:active{ cursor:grabbing; }

    /* Auth help banner */
    #auth-help{position:fixed;left:50%;transform:translateX(-50%);bottom:80px;z-index:10000;display:none}
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

  <!-- Login Overlay -->
  <div id="auth-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-95 z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-sm text-center">
      <h1 class="text-5xl font-bold text-white mb-2">Karmyog</h1>
      <p class="text-slate-400 mb-8">Sign in to begin your path of Abhyāsa.</p>
      <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl">
        <button id="google-signin-btn" class="w-full bg-white hover:bg-slate-200 text-slate-800 font-semibold py-3 px-4 rounded-lg flex items-center justify-center transition-transform transform hover:scale-105" aria-label="Sign in with Google">
          <img src="https://www.google.com/favicon.ico" alt="Google icon" class="w-6 h-6 mr-3"> Sign in with Google
        </button>
        <a href="#" id="google-redirect-fallback" class="mt-4 block text-sm text-indigo-400 hover:text-indigo-300">Having trouble? Try redirect sign-in</a>
        <div class="my-6 flex items-center"><hr class="w-full border-slate-600"><span class="px-4 text-slate-500 text-sm">OR</span><hr class="w-full border-slate-600"></div>
        <form id="email-form">
          <input type="email" id="email-input" placeholder="Email" class="w-full bg-slate-700 text-white p-3 rounded-lg mb-4 border-2 border-transparent focus:border-indigo-500 focus:ring-0" required>
          <input type="password" id="password-input" placeholder="Password (6+ characters)" class="w-full bg-slate-700 text-white p-3 rounded-lg mb-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0" required>
          <div class="text-right mb-4">
            <button type="button" id="forgot-password-btn" class="text-xs text-indigo-300 hover:text-indigo-200 underline">Forgot password?</button>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button type="button" id="email-signin-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Sign In</button>
            <button type="button" id="email-signup-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg">Sign Up</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Third-party cookies / storage help -->
  <div id="auth-help" class="bg-amber-100 text-amber-900 dark:bg-amber-900 dark:text-amber-100 px-3 py-2 rounded-md shadow">
    Third-party cookies or storage seem blocked. For Google sign-in, allow cookies for <b>accounts.google.com</b> (Safari: Settings ▶ Privacy ▶ disable “Prevent cross-site tracking”; Chrome: allow third-party cookies). Then try “Redirect sign-in”.
  </div>

  <!-- Sidebar + App (unchanged UI)… -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden" aria-hidden="true"></div>
  <div id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white dark:bg-slate-800 shadow-xl z-40 transform -translate-x-full p-6 flex flex-col" role="dialog" aria-label="Sidebar">
    <div class="flex-grow overflow-y-auto pr-2">
      <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">Your Abhyāsa</h2>
      <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg mb-6">
        <input type="text" id="goal-name-input" placeholder="New Practice Name..." class="w-full bg-white dark:bg-slate-600 p-2 rounded-md mb-2">
        <button id="add-goal-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-md">Create Practice</button>
      </div>
      <div id="sidebar-goal-list" class="space-y-4"></div>
      <div class="mt-8">
        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Badges</h3>
        <div id="sidebar-badge-container" class="grid grid-cols-4 gap-4 text-center"></div>
      </div>
      <div class="mt-8 bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
        <h3 class="text-xl font-bold mb-3">Reminders</h3>
        <label class="flex items-center justify-between mb-2">
          <span class="text-sm">In-app reminders</span>
          <input id="toggle-inapp-reminders" type="checkbox" class="scale-125">
        </label>
        <label class="flex items-center justify-between mb-2">
          <span class="text-sm">Web push (optional)</span>
          <input id="toggle-push-reminders" type="checkbox" class="scale-125">
        </label>
        <div class="grid grid-cols-2 gap-3 mt-3">
          <div>
            <label class="block text-xs mb-1">End Day Time</label>
            <input id="endday-time" type="time" class="w-full bg-white dark:bg-slate-600 p-2 rounded-md">
          </div>
          <div>
            <label class="block text-xs mb-1">Auto finalize (mins)</label>
            <input id="auto-finalize-mins" type="number" min="5" step="5" class="w-full bg-white dark:bg-slate-600 p-2 rounded-md">
          </div>
        </div>
      </div>
    </div>
    <div class="mt-auto pt-6 border-t border-slate-200 dark:border-slate-700 flex-shrink-0">
      <button id="reset-karma-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors mb-4">Reset Accumulated Karma</button>
      <button id="reset-day-btn" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg">End Day &amp; Evaluate</button>
    </div>
  </div>

  <div id="app-container" class="hidden container mx-auto max-w-2xl p-4 sm:p-6 with-bottom-nav">
    <header class="text-center mb-6 relative flex items-center justify-between">
      <button id="menu-btn" class="text-2xl text-slate-800 dark:text-slate-200" aria-label="Open menu"><i class="fas fa-bars"></i></button>
      <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white">Karmyog</h1>
      <div class="flex items-center gap-2">
        <button id="theme-toggle-btn" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-xs font-semibold py-2 px-3 rounded-lg" aria-label="Toggle dark mode">Theme</button>
        <button id="signout-btn" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-xs font-semibold py-2 px-4 rounded-lg">Sign Out</button>
      </div>
    </header>

    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg mb-6 sticky top-4 z-10 grid grid-cols-2 divide-x dark:divide-slate-700 text-center">
      <div>
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Today's Karma</p>
        <p id="daily-karma-score" class="text-4xl font-bold mt-1 score-value">0</p>
      </div>
      <div>
        <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Total Karma</p>
        <p id="total-karma-score" class="text-4xl font-bold mt-1 score-value">0</p>
      </div>
    </div>

    <p id="gita-quote" class="text-sm text-center text-slate-500 dark:text-slate-400 mt-3 mb-6 italic max-w-xl mx-auto"></p>

    <div id="view-tasks">
      <div id="task-list-container" class="min-h-screen">
        <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Today's Actions</h2>
        <ul id="task-list" class="space-y-4"></ul>
        <button id="add-karma-btn" class="w-full mt-6 bg-indigo-200 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-300 dark:hover:bg-indigo-900 font-semibold py-3 rounded-lg text-sm">+ Add New Action</button>
        <button id="quick-log-vikarma-btn" class="w-full mt-2 bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900 font-semibold py-3 rounded-lg text-sm">Log Vikarma Now</button>
      </div>
    </div>
  </div>

  <!-- Minimal Draggable Pen -->
  <button id="pen-fab" aria-label="Open journal" title="Journal">
    <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.0 1.0 0 0 0 0-1.41l-2.34-2.34a1.0 1.0 0 0 0-1.41 0l-1.82 1.82 3.75 3.75 1.82-1.82z" fill="currentColor"/>
    </svg>
  </button>

  <div id="message-box" class="hidden fixed bottom-16 right-5 p-4 text-sm rounded-lg shadow-lg z-50" role="alert"></div>
  <button id="installBtn" type="button">Install Karmyog</button>
  <audio id="fire-sound" src="https://cdn.freesound.org/previews/25/25431_132334-lq.mp3" preload="auto"></audio>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-messaging-compat.js"></script>

  <script>
    function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
    function localDateISO(d=new Date()){return d.toLocaleDateString('en-CA')}
    function setTheme(dark){document.documentElement.classList.toggle('dark',dark);const m=document.querySelector('meta[name="theme-color"]');if(m) m.setAttribute('content',dark?'#0f172a':'#f1f5f9');try{localStorage.setItem('theme',dark?'dark':'light')}catch(e){}}
    (function(){const s=(()=>{try{return localStorage.getItem('theme')}catch(e){return null}})();setTheme(s? s==='dark' : (window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches))})();

    const firebaseConfig={apiKey:"AIzaSyA1YxzDZzzyIuAxjxzo_Vy3d8CLtHoBK44",authDomain:"karmyog.life",projectId:"karmyog-6da5f",storageBucket:"karmyog-6da5f.firebasestorage.app",messagingSenderId:"331203556277",appId:"1:331203556277:web:b087b49debac40eeb6dffc",measurementId:"G-316W8DPVBN"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore(),auth=firebase.auth();

    const dom={
      authOverlay:document.getElementById('auth-overlay'),
      appContainer:document.getElementById('app-container'),
      googleSigninBtn:document.getElementById('google-signin-btn'),
      googleRedirectFallback:document.getElementById('google-redirect-fallback'),
      emailSigninBtn:document.getElementById('email-signin-btn'),
      emailSignupBtn:document.getElementById('email-signup-btn'),
      forgotPasswordBtn:document.getElementById('forgot-password-btn'),
      emailInput:document.getElementById('email-input'),
      passwordInput:document.getElementById('password-input'),
      signoutBtn:document.getElementById('signout-btn'),
      themeToggleBtn:document.getElementById('theme-toggle-btn'),
      dailyKarmaScoreEl:document.getElementById('daily-karma-score'),
      totalKarmaScoreEl:document.getElementById('total-karma-score'),
      gitaQuoteEl:document.getElementById('gita-quote'),
      taskList:document.getElementById('task-list'),
      resetDayBtn:document.getElementById('reset-day-btn'),
      resetKarmaBtn:document.getElementById('reset-karma-btn'),
      sidebar:document.getElementById('sidebar'),
      sidebarOverlay:document.getElementById('sidebar-overlay'),
      menuBtn:document.getElementById('menu-btn'),
      sidebarGoalList:document.getElementById('sidebar-goal-list'),
      sidebarBadgeContainer:document.getElementById('sidebar-badge-container'),
      addGoalBtn:document.getElementById('add-goal-btn'),
      goalNameInput:document.getElementById('goal-name-input'),
      addKarmaModal:document.getElementById('add-karma-modal'),
      addKarmaForm:document.getElementById('add-karma-form'),
      cancelAddKarmaBtn:document.getElementById('cancel-add-karma-btn'),
      addKarmaBtn:document.getElementById('add-karma-btn'),
      karmaGoalSelect:document.getElementById('karma-goal-select'),
      penFab:document.getElementById('pen-fab'),
      authHelp:document.getElementById('auth-help')
    };

    const makeId=()=> (crypto&&crypto.randomUUID? crypto.randomUUID(): `${Date.now()}-${Math.random()}`);
    let state={},unsubscribe;

    /* ---------- Auth: robust & cookie-safe ---------- */
    // Force LOCAL persistence so you don't get signed out on reload
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    // Basic “storage available” test (covers Safari ITP / disabled cookies)
    function storageHealthy(){
      try{ localStorage.setItem('_t','1'); localStorage.removeItem('_t'); return true; }catch(e){ return false; }
    }
    function showAuthHelp(show){ dom.authHelp.style.display = show ? 'block' : 'none'; }

    async function safeGoogleSignIn(forceRedirect=false){
      const provider=new firebase.auth.GoogleAuthProvider();
      // Prefer redirect for mobile & Safari/Firefox or when forced
      const ua=navigator.userAgent.toLowerCase();
      const preferRedirect = forceRedirect || /mobile|android|iphone|ipad|ipod/.test(ua) || /safari/.test(ua) && !/chrome|crios|edg/.test(ua) || !storageHealthy();
      try{
        if(preferRedirect){ await auth.signInWithRedirect(provider); return; }
        await auth.signInWithPopup(provider);
      }catch(err){
        // Popup blocked / third-party cookies → fall back to redirect
        const popupCodes=['auth/popup-blocked','auth/popup-closed-by-user','auth/cancelled-popup-request'];
        const storageCodes=['auth/web-storage-unsupported','auth/operation-not-supported-in-this-environment','auth/cookie-policy-unsupported'];
        if(popupCodes.includes(err.code)){ return auth.signInWithRedirect(provider); }
        if(storageCodes.includes(err.code)){ showAuthHelp(true); return auth.signInWithRedirect(provider); }
        alert(err.message||'Sign-in failed.');
      }
    }

    dom.googleSigninBtn.addEventListener('click',()=>safeGoogleSignIn(false));
    dom.googleRedirectFallback.addEventListener('click',(e)=>{e.preventDefault(); safeGoogleSignIn(true);});

    // Email auth
    document.getElementById('email-signup-btn').addEventListener('click',()=>{auth.createUserWithEmailAndPassword(dom.emailInput.value,dom.passwordInput.value).catch(e=>alert(e.message));});
    document.getElementById('email-signin-btn').addEventListener('click',()=>{auth.signInWithEmailAndPassword(dom.emailInput.value,dom.passwordInput.value).catch(e=>alert(e.message));});
    document.getElementById('forgot-password-btn').addEventListener('click',async ()=>{
      const email=dom.emailInput.value.trim();
      if(!email) return alert('Enter your email above first.');
      try{await auth.sendPasswordResetEmail(email); alert('Password reset email sent.');}
      catch(e){alert(e.message);}
    });

    auth.onAuthStateChanged(user=>{
      showAuthHelp(false);
      if(user){ dom.authOverlay.classList.add('hidden'); dom.appContainer.classList.remove('hidden'); loadState(user.uid); }
      else{ dom.authOverlay.classList.remove('hidden'); dom.appContainer.classList.add('hidden'); if(unsubscribe) unsubscribe(); state={}; }
    });

    function loadState(uid){
      const ref=db.collection('users').doc(uid);
      unsubscribe=ref.onSnapshot(doc=>{
        state=doc.exists? doc.data(): {totalKarma:0,dailyKarma:0,goals:[],unlockedBadges:[],dailyActions:[],settings:{endDayTime:"22:30",autoFinalizeAfterMins:30,remindersEnabled:true,pushRemindersEnabled:false},metrics:{completedPositiveToday:0,loggedNegativeToday:0}};
        renderAll();
      });
    }
    function saveState(){ const uid=auth.currentUser?.uid; if(!uid) return; db.collection('users').doc(uid).set(state,{merge:true}).catch(console.error); }

    /* ---------- UI renderers (unchanged) ---------- */
    function renderAll(){ renderSidebar(); renderTaskList(); updateStats(); document.getElementById('gita-quote').textContent="You have a right to perform your prescribed duties, but you are not entitled to the fruits of your actions. - 2.47"; }
    function renderSidebar(){ /* …keep your existing logic… */ }
    function renderTaskList(){ /* …keep your existing logic… */ }
    function updateStats(){ /* …keep your existing logic… */ }

    /* ---------- Draggable pen with reliable tap ---------- */
    (function initPen(){
      const btn=dom.penFab;
      // restore position
      try{
        const saved=JSON.parse(localStorage.getItem('pen-pos')||'null');
        if(saved && typeof saved.x==='number' && typeof saved.y==='number'){
          btn.style.left=saved.x+'px'; btn.style.top=saved.y+'px';
          btn.style.right='auto'; btn.style.bottom='auto';
        }
      }catch(e){}
      const THRESHOLD=6; // px
      let drag=null, moved=false;
      function onStart(ev){
        moved=false;
        const p=('touches' in ev)? ev.touches[0] : ev;
        const r=btn.getBoundingClientRect();
        drag={startX:p.clientX,startY:p.clientY,originX:r.left,originY:r.top};
        ev.preventDefault();
      }
      function onMove(ev){
        if(!drag) return;
        const p=('touches' in ev)? ev.touches[0] : ev;
        const dx=p.clientX-drag.startX, dy=p.clientY-drag.startY;
        if(Math.abs(dx)>THRESHOLD || Math.abs(dy)>THRESHOLD) moved=true;
        let x=drag.originX + dx, y=drag.originY + dy;
        const w=innerWidth, h=innerHeight;
        x=Math.max(8,Math.min(x,w-52)); y=Math.max(8,Math.min(y,h-52));
        btn.style.left=x+'px'; btn.style.top=y+'px'; btn.style.right='auto'; btn.style.bottom='auto';
      }
      function onEnd(){
        if(!drag) return;
        const r=btn.getBoundingClientRect();
        const x = (r.left < innerWidth/2) ? 12 : innerWidth - r.width - 12;
        const y = Math.max(8, Math.min(r.top, innerHeight - r.height - 8));
        btn.style.left=x+'px'; btn.style.top=y+'px'; btn.style.right='auto'; btn.style.bottom='auto';
        try{localStorage.setItem('pen-pos',JSON.stringify({x,y}));}catch(e){}
        drag=null;
      }
      btn.addEventListener('mousedown',onStart); addEventListener('mousemove',onMove); addEventListener('mouseup',onEnd);
      btn.addEventListener('touchstart',onStart,{passive:false}); addEventListener('touchmove',onMove,{passive:false}); addEventListener('touchend',onEnd);
      btn.addEventListener('click',()=>{ if(!moved) location.href='journal.html'; });
    })();

    /* Signout */
    document.getElementById('signout-btn').addEventListener('click',()=>auth.signOut());
  </script>

  <!-- PWA Service Worker and Install Prompt -->
  <script>
    const SW_PATH='./service-worker.js';
    if('serviceWorker' in navigator){
      window.addEventListener('load',async ()=>{
        try{
          const reg=await navigator.serviceWorker.register(SW_PATH);
          if(reg.waiting){reg.waiting.postMessage({type:'SKIP_WAITING'});}
          reg.addEventListener('updatefound',()=>{const nw=reg.installing; if(!nw) return; nw.addEventListener('statechange',()=>{if(nw.state==='installed'&&navigator.serviceWorker.controller){nw.postMessage({type:'SKIP_WAITING'});}});});
          navigator.serviceWorker.addEventListener('controllerchange',()=>{if(!window.__reloadedForSW){window.__reloadedForSW=true; location.reload();}});
        }catch(err){console.log('ServiceWorker registration failed: ',err);}
      });
    }
    let deferredPrompt; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault(); deferredPrompt=e; installBtn.style.display='inline-block';});
    installBtn.addEventListener('click',async ()=>{installBtn.style.display='none'; if(deferredPrompt){deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;}});
    window.addEventListener('appinstalled',()=>{installBtn.style.display='none'; deferredPrompt=null;});
  </script>
</body>
</html>
