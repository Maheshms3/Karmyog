<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Karmyog - Your Path of AbhyÄsa</title>
Â  <link rel="canonical" href="https://karmyog.life/" />

Â  Â  <meta name="theme-color" content="#1e293b" />
Â  <meta name="apple-mobile-web-app-capable" content="yes" />
Â  <link rel="manifest" href="manifest.json" />
Â  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />

Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script> tailwind.config = { darkMode: 'class' }; </script>

Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

Â  <style>
Â  Â  body { font-family: 'Inter', sans-serif; user-select: none; overflow-x: hidden; }
Â  Â  .karma-item { transition: opacity 0.5s ease, transform 0.5s ease; position: relative; }
Â  Â  .karma-item.completed { opacity: 0; transform: scale(0.5) translateX(100%); }
Â  Â  .fire-overlay { position: absolute; inset: 0; background: rgba(255, 165, 0, 0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 0.75rem; }
Â  Â  .karma-positive { color: #22c55e; }
Â  Â  .karma-negative { color: #ef4444; }
Â  Â  .karma-neutral { color: #64748b; }
Â  Â  .badge { transition: transform 0.3s ease, filter 0.3s ease; }
Â  Â  .badge.unlocked { filter: none; }
Â  Â  .badge.locked { filter: grayscale(100%) opacity(0.4); }
Â  Â  .badge:hover { transform: scale(1.1); }
Â  Â  #sidebar { transition: transform 0.3s ease-in-out; }
Â  Â  #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
Â  Â  .vikarma-card { background-color: #fef2f2; }
Â  Â  .dark .vikarma-card { background-color: rgba(153, 27, 27, 0.2); }
Â  Â  .prayashchit-card { background-color: #fffbeb; }
Â  Â  .dark .prayashchit-card { background-color: rgba(180, 83, 9, 0.2); }
Â  Â  .dragging { opacity: 0.5; cursor: grabbing; }
Â  Â  .score-value { transition: color 0.5s ease; }
Â  Â  .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
Â  Â  @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

Â  Â  #installBtn {
Â  Â  Â  position: fixed; right: 1rem; bottom: 4.5rem; padding: 0.7rem 1rem; border: 0;
Â  Â  Â  border-radius: 0.6rem; font: 600 14px/1.2 system-ui, sans-serif;
Â  Â  Â  background: #4f46e5; color: #fff; cursor: pointer;
Â  Â  Â  display: none; z-index: 100;
Â  Â  }

Â  Â  .badge-ceremony-icon { animation: spin-and-glow 1.5s ease-in-out; }
Â  Â  @keyframes spin-and-glow {
Â  Â  Â  0% { transform: scale(0.5) rotate(0deg); filter: drop-shadow(0 0 0px white); }
Â  Â  Â  50% { transform: scale(1.2) rotate(360deg); filter: drop-shadow(0 0 15px white); }
Â  Â  Â  100% { transform: scale(1) rotate(360deg); filter: drop-shadow(0 0 5px white); }
Â  Â  }

Â  Â  /* Bottom nav spacing */
Â  Â  .with-bottom-nav { padding-bottom: 64px; }
Â  </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

Â  Â  <div id="auth-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-95 z-50 flex items-center justify-center p-4">
Â  Â  <div class="w-full max-w-sm text-center">
Â  Â  Â  <h1 class="text-5xl font-bold text-white mb-2">Karmyog</h1>
Â  Â  Â  <p class="text-slate-400 mb-8">Sign in to begin your path of AbhyÄsa.</p>
Â  Â  Â  <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl">
Â  Â  Â  Â  <button id="google-signin-btn" class="w-full bg-white hover:bg-slate-200 text-slate-800 font-semibold py-3 px-4 rounded-lg flex items-center justify-center transition-transform transform hover:scale-105" aria-label="Sign in with Google">
Â  Â  Â  Â  Â  <img src="https://www.google.com/favicon.ico" alt="Google icon" class="w-6 h-6 mr-3"> Sign in with Google
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <a href="#" id="google-redirect-fallback" class="hidden mt-4 text-sm text-indigo-400 hover:text-indigo-300">Pop-up blocked? Try alternate sign-in</a>

Â  Â  Â  Â  <div class="my-6 flex items-center"><hr class="w-full border-slate-600"><span class="px-4 text-slate-500 text-sm">OR</span><hr class="w-full border-slate-600"></div>
Â  Â  Â  Â  <form id="email-form">
Â  Â  Â  Â  Â  <input type="email" id="email-input" placeholder="Email" class="w-full bg-slate-700 text-white p-3 rounded-lg mb-4 border-2 border-transparent focus:border-indigo-500 focus:ring-0" required>
Â  Â  Â  Â  Â  <input type="password" id="password-input" placeholder="Password (6+ characters)" class="w-full bg-slate-700 text-white p-3 rounded-lg mb-2 border-2 border-transparent focus:border-indigo-500 focus:ring-0" required>
Â  Â  Â  Â  Â  <div class="text-right mb-4">
Â  Â  Â  Â  Â  Â  <button type="button" id="forgot-password-btn" class="text-xs text-indigo-300 hover:text-indigo-200 underline">Forgot password?</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-3">
Â  Â  Â  Â  Â  Â  <button type="button" id="email-signin-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Sign In</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="email-signup-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg">Sign Up</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </form>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden" aria-hidden="true"></div>
Â  <div id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white dark:bg-slate-800 shadow-xl z-40 transform -translate-x-full p-6 flex flex-col" role="dialog" aria-label="Sidebar">
Â  Â  <div class="flex-grow overflow-y-auto pr-2">
Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">Your AbhyÄsa</h2>
Â  Â  Â  <div class="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg mb-6">
Â  Â  Â  Â  <input type="text" id="goal-name-input" placeholder="New Practice Name..." class="w-full bg-white dark:bg-slate-600 p-2 rounded-md mb-2">
Â  Â  Â  Â  <button id="add-goal-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-md">Create Practice</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="sidebar-goal-list" class="space-y-4"></div>

Â  Â  Â  <div class="mt-8">
Â  Â  Â  Â  <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Badges</h3>
Â  Â  Â  Â  <div id="sidebar-badge-container" class="grid grid-cols-4 gap-4 text-center"></div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-8 bg-slate-100 dark:bg-slate-700 p-4 rounded-lg">
Â  Â  Â  Â  <h3 class="text-xl font-bold mb-3">Reminders</h3>
Â  Â  Â  Â  <label class="flex items-center justify-between mb-2">
Â  Â  Â  Â  Â  <span class="text-sm">In-app reminders</span>
Â  Â  Â  Â  Â  <input id="toggle-inapp-reminders" type="checkbox" class="scale-125">
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <label class="flex items-center justify-between mb-2">
Â  Â  Â  Â  Â  <span class="text-sm">Web push (optional)</span>
Â  Â  Â  Â  Â  <input id="toggle-push-reminders" type="checkbox" class="scale-125">
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <div class="grid grid-cols-2 gap-3 mt-3">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="block text-xs mb-1">End Day Time</label>
Â  Â  Â  Â  Â  Â  <input id="endday-time" type="time" class="w-full bg-white dark:bg-slate-600 p-2 rounded-md">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="block text-xs mb-1">Auto finalize (mins)</label>
Â  Â  Â  Â  Â  Â  <input id="auto-finalize-mins" type="number" min="5" step="5" class="w-full bg-white dark:bg-slate-600 p-2 rounded-md">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="mt-auto pt-6 border-t border-slate-200 dark:border-slate-700 flex-shrink-0">
Â  Â  Â  <button id="reset-karma-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors mb-4">Reset Accumulated Karma</button>
Â  Â  Â  <button id="reset-day-btn" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg">End Day &amp; Evaluate</button>
Â  Â  </div>
Â  </div>

Â  Â  <div id="app-container" class="hidden container mx-auto max-w-2xl p-4 sm:p-6 with-bottom-nav">
Â  Â  <header class="text-center mb-6 relative flex items-center justify-between">
Â  Â  Â  <button id="menu-btn" class="text-2xl text-slate-800 dark:text-slate-200" aria-label="Open menu"><i class="fas fa-bars"></i></button>
Â  Â  Â  <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white">Karmyog</h1>
Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  <button id="theme-toggle-btn" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-xs font-semibold py-2 px-3 rounded-lg" aria-label="Toggle dark mode">Theme</button>
Â  Â  Â  Â  <button id="signout-btn" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-xs font-semibold py-2 px-4 rounded-lg">Sign Out</button>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg mb-6 sticky top-4 z-10 grid grid-cols-2 divide-x dark:divide-slate-700 text-center">
Â  Â  Â  <div>
Â  Â  Â  Â  <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Today's Karma</p>
Â  Â  Â  Â  <p id="daily-karma-score" class="text-4xl font-bold mt-1 score-value">0</p>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <p class="text-sm font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Total Karma</p>
Â  Â  Â  Â  <p id="total-karma-score" class="text-4xl font-bold mt-1 score-value">0</p>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <p id="gita-quote" class="text-sm text-center text-slate-500 dark:text-slate-400 mt-3 mb-6 italic max-w-xl mx-auto"></p>

Â  Â  Â  Â  <div id="view-tasks">
Â  Â  Â  <div id="task-list-container" class="min-h-screen">
Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Today's Actions</h2>
Â  Â  Â  Â  <ul id="task-list" class="space-y-4"></ul>
Â  Â  Â  Â  <button id="add-karma-btn" class="w-full mt-6 bg-indigo-200 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-300 dark:hover:bg-indigo-900 font-semibold py-3 rounded-lg text-sm">+ Add New Action</button>
Â  Â  Â  Â  <button id="quick-log-vikarma-btn" class="w-full mt-2 bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900 font-semibold py-3 rounded-lg text-sm">Log Vikarma Now</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="view-diary" class="hidden">
Â  Â  Â  <h2 class="text-2xl font-bold mb-4">Daily Diary</h2>
Â  Â  Â  <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow mb-4">
Â  Â  Â  Â  <input id="note-title" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg mb-3" placeholder="Title (optional)">
Â  Â  Â  Â  <textarea id="note-body" rows="5" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg mb-3" placeholder="Write your note..."></textarea>
Â  Â  Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  Â  Â  <button id="btn-dictate" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-microphone"></i> Dictate</button>
Â  Â  Â  Â  Â  <button id="btn-record" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-microphone-lines"></i> Record</button>
Â  Â  Â  Â  Â  <button id="btn-save-note" class="ml-auto bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg">Save Note</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div id="notes-list" class="space-y-3"></div>
Â  Â  </div>
Â  </div>

Â  Â  <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t dark:border-slate-700 z-40">
Â  Â  <div class="max-w-2xl mx-auto grid grid-cols-3 text-center">
Â  Â  Â  <button id="tab-tasks" class="py-3 font-semibold">Tasks</button>
Â  Â  Â  <button id="tab-diary" class="py-3">Diary</button>
Â  Â  Â  <button id="tab-profile" class="py-3">Profile</button>
Â  Â  </div>
Â  </nav>

Â  Â  <div id="add-karma-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Add New Action">
Â  Â  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full modal-enter">
Â  Â  Â  <h2 class="text-2xl font-bold mb-4">Add New Action</h2>
Â  Â  Â  <form id="add-karma-form">
Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  <label for="karma-goal-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Assign to Practice (AbhyÄsa)</label>
Â  Â  Â  Â  Â  <select id="karma-goal-select" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg" required></select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input type="text" id="karma-name" placeholder="Action name..." class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg mb-4" required>
Â  Â  Â  Â  <select id="karma-type" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg mb-4">
Â  Â  Â  Â  Â  <option value="karma">Karma (Positive Action)</option>
Â  Â  Â  Â  Â  <option value="vikarma">Vikarma (Negative Action)</option>
Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-3 mb-6">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="block text-sm mb-1">Reminder Time</label>
Â  Â  Â  Â  Â  Â  <input id="karma-remind-at" type="time" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <label class="block text-sm mb-1">Deadline</label>
Â  Â  Â  Â  Â  Â  <input id="karma-deadline-at" type="time" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="flex justify-end space-x-3">
Â  Â  Â  Â  Â  <button type="button" id="cancel-add-karma-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
Â  Â  Â  Â  Â  <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Add Action</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </form>
Â  Â  </div>
Â  </div>

Â  <div id="prayashchit-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Prayashchit">
Â  Â  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full text-center modal-enter">
Â  Â  Â  <i class="fas fa-person-praying text-5xl text-amber-600 mb-4" aria-hidden="true"></i>
Â  Â  Â  <h2 class="text-3xl font-bold">Prayashchit (Penance)</h2>
Â  Â  Â  <p class="mt-2 mb-6">Your daily Karma is negative. Choose a penance to restore balance for tomorrow:</p>
Â  Â  Â  <div id="prayashchit-options" class="space-y-3 text-left mb-6"></div>
Â  Â  Â  <div class="mt-4 pt-4 border-t dark:border-slate-700">
Â  Â  Â  Â  <input type="text" id="custom-prayashchit-input" placeholder="Or add your own..." class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-md mb-2">
Â  Â  Â  Â  <button id="add-custom-prayashchit-btn" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 rounded-md text-sm">Add Custom Penance</button>
Â  Â  Â  </div>
Â  Â  Â  <button id="accept-prayashchit-btn" class="w-full mt-4 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg">Accept &amp; End Day</button>
Â  Â  </div>
Â  </div>

Â  <div id="badge-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Badge">
Â  Â  <div id="badge-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center modal-enter"></div>
Â  </div>

Â  <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Daily Summary">
Â  Â  <div id="summary-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center modal-enter"></div>
Â  Â  <div id="summary-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center modal-enter"></div>
Â  </div>

Â  <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" role="dialog" aria-label="Confirmation">
Â  Â  <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center modal-enter">
Â  Â  Â  <h2 id="confirm-modal-title" class="text-2xl font-bold mb-4">Are you sure?</h2>
Â  Â  Â  <p id="confirm-modal-text" class="text-slate-500 dark:text-slate-400 mb-6">This action cannot be undone.</p>
Â  Â  Â  <div class="flex justify-center space-x-4">
Â  Â  Â  Â  <button id="confirm-modal-cancel-btn" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
Â  Â  Â  Â  <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="message-box" class="hidden fixed bottom-16 right-5 p-4 text-sm rounded-lg shadow-lg z-50" role="alert"></div>
Â  <button id="installBtn" type="button">Install Karmyog</button>
Â  <audio id="fire-sound" src="https://cdn.freesound.org/previews/25/25431_132334-lq.mp3" preload="auto"></audio>

Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-storage-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-messaging-compat.js"></script>

Â  <script>
Â  Â  // ---- Security: escape helper ----
Â  Â  function esc(s) {
Â  Â  Â  return String(s)
Â  Â  Â  Â  .replace(/&/g,"&amp;").replace(/</g,"&lt;")
Â  Â  Â  Â  .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
Â  Â  Â  Â  .replace(/'/g,"&#39;");
Â  Â  }
Â  Â  // ---- Local date helper (YYYY-MM-DD in user TZ) ----
Â  Â  function localDateISO(d = new Date()) {
Â  Â  Â  // en-CA gives YYYY-MM-DD in most browsers
Â  Â  Â  return d.toLocaleDateString('en-CA');
Â  Â  }

Â  Â  // ---- Theme ----
Â  Â  function setTheme(dark) {
Â  Â  Â  document.documentElement.classList.toggle('dark', dark);
Â  Â  Â  const meta = document.querySelector('meta[name="theme-color"]');
Â  Â  Â  if (meta) meta.setAttribute('content', dark ? '#0f172a' : '#f1f5f9');
Â  Â  Â  try { localStorage.setItem('theme', dark ? 'dark' : 'light'); } catch(e){}
Â  Â  }
Â  Â  (function initTheme(){
Â  Â  Â  const saved = (() => { try { return localStorage.getItem('theme'); } catch(e){ return null; }})();
Â  Â  Â  setTheme(saved ? saved === 'dark' : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches));
Â  Â  })();
 
    // This section is now a placeholder.
    // Netlify's build process will replace these placeholders with the actual values.
    // The keys will be added to Netlify's Environment Variables panel.
    const firebaseConfig = {
      apiKey: '%%FIREBASE_API_KEY%%',
      authDomain: '%%FIREBASE_AUTH_DOMAIN%%',
      projectId: '%%FIREBASE_PROJECT_ID%%',
      storageBucket: '%%FIREBASE_STORAGE_BUCKET%%',
      messagingSenderId: '%%FIREBASE_MESSAGING_SENDER_ID%%',
      appId: '%%FIREBASE_APP_ID%%',
      measurementId: '%%FIREBASE_MEASUREMENT_ID%%'
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
    let messaging = null; // used only if push is enabled

Â  Â  // --- DOM ---
Â  Â  const dom = {
Â  Â  Â  authOverlay: document.getElementById('auth-overlay'),
Â  Â  Â  appContainer: document.getElementById('app-container'),
Â  Â  Â  googleSigninBtn: document.getElementById('google-signin-btn'),
Â  Â  Â  googleRedirectFallback: document.getElementById('google-redirect-fallback'),
Â  Â  Â  emailSigninBtn: document.getElementById('email-signin-btn'),
Â  Â  Â  emailSignupBtn: document.getElementById('email-signup-btn'),
Â  Â  Â  forgotPasswordBtn: document.getElementById('forgot-password-btn'),
Â  Â  Â  emailInput: document.getElementById('email-input'),
Â  Â  Â  passwordInput: document.getElementById('password-input'),
Â  Â  Â  signoutBtn: document.getElementById('signout-btn'),
Â  Â  Â  themeToggleBtn: document.getElementById('theme-toggle-btn'),
Â  Â  Â  dailyKarmaScoreEl: document.getElementById('daily-karma-score'),
Â  Â  Â  totalKarmaScoreEl: document.getElementById('total-karma-score'),
Â  Â  Â  gitaQuoteEl: document.getElementById('gita-quote'),
Â  Â  Â  taskList: document.getElementById('task-list'),
Â  Â  Â  resetDayBtn: document.getElementById('reset-day-btn'),
Â  Â  Â  resetKarmaBtn: document.getElementById('reset-karma-btn'),
Â  Â  Â  sidebar: document.getElementById('sidebar'),
Â  Â  Â  sidebarOverlay: document.getElementById('sidebar-overlay'),
Â  Â  Â  menuBtn: document.getElementById('menu-btn'),
Â  Â  Â  sidebarGoalList: document.getElementById('sidebar-goal-list'),
Â  Â  Â  sidebarBadgeContainer: document.getElementById('sidebar-badge-container'),
Â  Â  Â  addGoalBtn: document.getElementById('add-goal-btn'),
Â  Â  Â  goalNameInput: document.getElementById('goal-name-input'),
Â  Â  Â  addKarmaModal: document.getElementById('add-karma-modal'),
Â  Â  Â  addKarmaForm: document.getElementById('add-karma-form'),
Â  Â  Â  cancelAddKarmaBtn: document.getElementById('cancel-add-karma-btn'),
Â  Â  Â  addKarmaBtn: document.getElementById('add-karma-btn'),
Â  Â  Â  karmaGoalSelect: document.getElementById('karma-goal-select'),
Â  Â  Â  prayashchitModal: document.getElementById('prayashchit-modal'),
Â  Â  Â  prayashchitOptionsEl: document.getElementById('prayashchit-options'),
Â  Â  Â  acceptPrayashchitBtn: document.getElementById('accept-prayashchit-btn'),
Â  Â  Â  customPrayashchitInput: document.getElementById('custom-prayashchit-input'),
Â  Â  Â  addCustomPrayashchitBtn: document.getElementById('add-custom-prayashchit-btn'),
Â  Â  Â  fireSound: document.getElementById('fire-sound'),
Â  Â  Â  badgeModal: document.getElementById('badge-modal'),
Â  Â  Â  badgeModalContent: document.getElementById('badge-modal-content'),
Â  Â  Â  summaryModal: document.getElementById('summary-modal'),
Â  Â  Â  summaryModalContent: document.getElementById('summary-modal-content'),
Â  Â  Â  confirmModal: document.getElementById('confirm-modal'),
Â  Â  Â  confirmModalTitle: document.getElementById('confirm-modal-title'),
Â  Â  Â  confirmModalText: document.getElementById('confirm-modal-text'),
Â  Â  Â  confirmModalCancelBtn: document.getElementById('confirm-modal-cancel-btn'),
Â  Â  Â  confirmModalConfirmBtn: document.getElementById('confirm-modal-confirm-btn'),
Â  Â  Â  // settings
Â  Â  Â  remindersToggle: document.getElementById('toggle-inapp-reminders'),
Â  Â  Â  pushToggle: document.getElementById('toggle-push-reminders'),
Â  Â  Â  endDayTimeInput: document.getElementById('endday-time'),
Â  Â  Â  autoFinalizeInput: document.getElementById('auto-finalize-mins'),
Â  Â  Â  // Diary
Â  Â  Â  noteTitle: document.getElementById('note-title'),
Â  Â  Â  noteBody: document.getElementById('note-body'),
Â  Â  Â  btnDictate: document.getElementById('btn-dictate'),
Â  Â  Â  btnRecord: document.getElementById('btn-record'),
Â  Â  Â  btnSaveNote: document.getElementById('btn-save-note'),
Â  Â  Â  notesList: document.getElementById('notes-list'),
Â  Â  Â  // Tabs
Â  Â  Â  viewTasks: document.getElementById('view-tasks'),
Â  Â  Â  viewDiary: document.getElementById('view-diary'),
Â  Â  Â  tabTasks: document.getElementById('tab-tasks'),
Â  Â  Â  tabDiary: document.getElementById('tab-diary')
Â  Â  };

Â  Â  // --- Helpers ---
Â  Â  const makeId = () => (crypto && crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`);

Â  Â  // --- App State ---
Â  Â  let state = {};
Â  Â  let unsubscribe;
Â  Â  let pendingFinalDailyKarma = null;
Â  Â  let confirmAction = null;
Â  Â  let notesUnsub = null;

Â  Â  const defaultState = {
Â  Â  Â  totalKarma: 0,
Â  Â  Â  dailyKarma: 0,
Â  Â  Â  goals: [],
Â  Â  Â  unlockedBadges: [],
Â  Â  Â  dailyActions: [],
Â  Â  Â  customPrayashchits: [],
Â  Â  Â  settings: {
Â  Â  Â  Â  endDayTime: "22:30",
Â  Â  Â  Â  autoFinalizeAfterMins: 30,
Â  Â  Â  Â  remindersEnabled: true,
Â  Â  Â  Â  pushRemindersEnabled: false
Â  Â  Â  },
Â  Â  Â  lastFinalizedDate: null,
Â  Â  Â  metrics: { completedPositiveToday: 0, loggedNegativeToday: 0 } // NEW
Â  Â  };

Â  Â  const badges = [
Â  Â  Â  { days: 9, name: 'Arjuna', icon: 'fa-user-graduate', color: 'text-slate-500', meaning: 'The focused warrior, beginning the path.' },
Â  Â  Â  { days: 18, name: 'SthitaprajÃ±a', icon: 'fa-brain', color: 'text-sky-500', meaning: 'One of steady wisdom, undisturbed by dualities.' },
Â  Â  Â  { days: 27, name: 'Yuktah', icon: 'fa-link', color: 'text-blue-500', meaning: 'One who is linked in yoga, harmonious.' },
Â  Â  Â  { days: 36, name: 'Niyatam', icon: 'fa-calendar-check', color: 'text-indigo-500', meaning: 'One who performs prescribed duties consistently.' },
Â  Â  Â  { days: 45, name: 'AkartÄ', icon: 'fa-hand-paper', color: 'text-purple-500', meaning: 'The non-doer, realizing the self is not the agent.' },
Â  Â  Â  { days: 54, name: 'TyÄgÄ«', icon: 'fa-leaf', color: 'text-emerald-500', meaning: 'The renouncer of the fruits of action.' },
Â  Â  Â  { days: 63, name: 'Samatvam', icon: 'fa-scale-balanced', color: 'text-lime-500', meaning: 'One who maintains equanimity in success and failure.' },
Â  Â  Â  { days: 72, name: 'Bhakta', icon: 'fa-heart', color: 'text-rose-500', meaning: 'A devoted soul, connected with love.' },
Â  Â  Â  { days: 81, name: 'JÃ±ÄnÄ«', icon: 'fa-book-open', color: 'text-amber-500', meaning: 'One who possesses true knowledge.' },
Â  Â  Â  { days: 90, name: 'YogÄ«', icon: 'fa-star', color: 'text-orange-500', meaning: 'A master of the self, united with the divine.' },
Â  Â  Â  { days: 99, name: 'BrahmabhÅ«ta', icon: 'fa-star-of-life', color: 'text-yellow-400', meaning: 'One who has attained the Brahman platform.' },
Â  Â  Â  { days: 108, name: 'Ä€tmarÄma', icon: 'fa-sun', color: 'text-yellow-300', meaning: 'One who rejoices in the Self.' }
Â  Â  ];

Â  Â  const gitaQuotes = [
Â  Â  Â  "You have a right to perform your prescribed duties, but you are not entitled to the fruits of your actions. - 2.47",
Â  Â  Â  "Perform your obligatory duty, because action is indeed better than inaction. - 3.8",
Â  Â  Â  "The wise see inaction in action and action in inaction. - 4.18",
Â  Â  Â  "One who performs their duty without attachment, surrendering the results to the Supreme Lord, is unaffected by sinful action. - 5.10",
Â  Â  Â  "It is better to live your own destiny imperfectly than to live an imitation of somebody else's life with perfection. - 3.35"
Â  Â  ];
Â  Â  const prayashchitList = [ "Take a cold water bath", "Avoid all sugar for 24 hours", "Use stairs instead of the lift", "30 minutes of selfless service (seva)", "Maintain silence for 2 hours" ];

Â  Â  // --- Auth & State ---
Â  Â  auth.onAuthStateChanged(user => {
Â  Â  Â  if (user) {
Â  Â  Â  Â  dom.authOverlay.classList.add('hidden');
Â  Â  Â  Â  dom.appContainer.classList.remove('hidden');
Â  Â  Â  Â  loadState(user.uid);
Â  Â  Â  Â  watchNotes();
Â  Â  Â  } else {
Â  Â  Â  Â  dom.authOverlay.classList.remove('hidden');
Â  Â  Â  Â  dom.appContainer.classList.add('hidden');
Â  Â  Â  Â  if (unsubscribe) unsubscribe();
Â  Â  Â  Â  if (notesUnsub) notesUnsub();
Â  Â  Â  Â  state = {};
Â  Â  Â  }
Â  Â  });

Â  Â  auth.getRedirectResult()
Â  Â  Â  .then((result) => { if (result.user) { showMessage(`Welcome, ${result.user.displayName || 'friend'}!`, 'success'); } })
Â  Â  Â  .catch((error) => { if (error.code !== 'auth/no-auth-event') { showMessage(error.message, 'error'); } });

Â  Â  function loadState(userId) {
Â  Â  Â  const docRef = db.collection('users').doc(userId);
Â  Â  Â  unsubscribe = docRef.onSnapshot(doc => {
Â  Â  Â  Â  state = doc.exists ? doc.data() : JSON.parse(JSON.stringify(defaultState));
Â  Â  Â  Â  if (!state.dailyActions) state.dailyActions = [];
Â  Â  Â  Â  if (!state.goals) state.goals = [];
Â  Â  Â  Â  if (!state.customPrayashchits) state.customPrayashchits = [];
Â  Â  Â  Â  if (!state.settings) state.settings = JSON.parse(JSON.stringify(defaultState.settings));
Â  Â  Â  Â  if (!state.metrics) state.metrics = { completedPositiveToday: 0, loggedNegativeToday: 0 }; // ensure metrics exist

Â  Â  Â  Â  state.goals.forEach(g => {
Â  Â  Â  Â  Â  if (g.totalPracticeKarma === undefined) g.totalPracticeKarma = 0;
Â  Â  Â  Â  Â  if (g.completedOneToday === undefined) g.completedOneToday = false;
Â  Â  Â  Â  Â  if (g.hadTasksToday === undefined) g.hadTasksToday = false;
Â  Â  Â  Â  });
Â  Â  Â  Â  if (!doc.exists) saveState();
Â  Â  Â  Â  renderAll();
Â  Â  Â  Â  maybeFinalizeMissedDay();
Â  Â  Â  Â  scheduleForegroundReminders();
Â  Â  Â  Â  maybeShowQueuedSummary(); // show any queued summary immediately
Â  Â  Â  });
Â  Â  }

Â  Â  function saveState() {
Â  Â  Â  if (auth.currentUser) {
Â  Â  Â  Â  db.collection('users').doc(auth.currentUser.uid).set(state, { merge: true })
Â  Â  Â  Â  Â  .catch(error => console.error("Error saving state: ", error));
Â  Â  Â  }
Â  Â  }

Â  Â  // --- Rendering ---
Â  Â  function renderAll() {
Â  Â  Â  if (!state.goals) return;
Â  Â  Â  renderSidebar();
Â  Â  Â  renderTaskList();
Â  Â  Â  updateStats();
Â  Â  Â  initSettingsUI();
Â  Â  Â  showGitaQuoteOnce();
Â  Â  }

Â  Â  function renderSidebar() {
Â  Â  Â  dom.sidebarGoalList.innerHTML = '';
Â  Â  Â  if (state.goals.length > 0) {
Â  Â  Â  Â  state.goals.forEach(goal => {
Â  Â  Â  Â  Â  const goalIdStr = String(goal.id);
Â  Â  Â  Â  Â  dom.sidebarGoalList.innerHTML += `
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  <span class="font-semibold">${esc(goal.name)}</span>
Â  Â  Â  Â  Â  Â  Â  <div class="text-right flex-shrink-0 ml-2">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-sm">SÄtatya: ${goal.satatya || 0}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-slate-400">Karma: ${goal.totalPracticeKarma || 0}</p>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <button class="delete-goal-btn text-slate-400 hover:text-red-500 ml-2" data-goal-id="${goalIdStr}" aria-label="Delete practice"><i class="fas fa-trash"></i></button>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  dom.sidebarGoalList.innerHTML = `<p class="text-sm text-slate-500 italic">Create your first practice above.</p>`;
Â  Â  Â  }
Â  Â  Â  renderBadges();
Â  Â  }

Â  Â  function renderTaskList() {
Â  Â  Â  dom.taskList.innerHTML = '';
Â  Â  Â  if (state.dailyActions.length === 0) {
Â  Â  Â  Â  dom.taskList.innerHTML = `<p class="text-center text-slate-500 italic py-8">A fresh start. Add your actions for today.</p>`;
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  state.dailyActions.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(task => {
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.className = 'karma-item bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md';
Â  Â  Â  Â  li.dataset.id = String(task.id);
Â  Â  Â  Â  li.draggable = true;

Â  Â  Â  Â  const goal = state.goals.find(g => String(g.id) === String(task.goalId));
Â  Â  Â  Â  const goalName = goal ? goal.name : 'Penance';
Â  Â  Â  Â  const deleteBtnHTML = `<button class="delete-task-btn text-slate-400 hover:text-red-500 text-xs ml-2" aria-label="Delete action"><i class="fas fa-times"></i></button>`;

Â  Â  Â  Â  const safeName = esc(task.name);
Â  Â  Â  Â  const safeGoalName = esc(goalName);
Â  Â  Â  Â  const timing = (task.remindAt || task.deadlineAt)
Â  Â  Â  Â  Â  ? `<div class="text-[11px] text-slate-400 mt-1">${task.remindAt ? `ğŸ”” ${task.remindAt}` : ''} ${task.deadlineAt ? `â€¢ â° ${task.deadlineAt}` : ''}</div>`
Â  Â  Â  Â  Â  : '';

Â  Â  Â  Â  if (task.type === 'prayashchit') {
Â  Â  Â  Â  Â  li.classList.add('prayashchit-card');
Â  Â  Â  Â  Â  li.innerHTML = `<div class="flex items-center"><i class="fas fa-person-praying text-amber-500 mr-4" aria-hidden="true"></i><div><p class="font-semibold text-lg">${safeName}</p><p class="text-xs text-slate-400">Prayashchit (from yesterday)</p>${timing}</div></div>`;
Â  Â  Â  Â  } else if (task.type === 'karma') {
Â  Â  Â  Â  Â  li.innerHTML = `<div class="flex items-center justify-between">
Â  Â  Â  Â  Â  Â  <div class="flex items-center">
Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-leaf text-green-500 mr-4" aria-hidden="true"></i>
Â  Â  Â  Â  Â  Â  Â  <div><p class="font-semibold text-lg">${safeName}</p><p class="text-xs text-slate-400">${safeGoalName}</p>${timing}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex items-center"><span class="font-bold text-green-500 mx-2">+1</span>${deleteBtnHTML}</div></div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  li.classList.add('vikarma-card');
Â  Â  Â  Â  Â  li.innerHTML = `<div class="flex items-center justify-between">
Â  Â  Â  Â  Â  Â  <div class="flex items-center">
Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-leaf text-slate-400 mr-4" aria-hidden="true"></i>
Â  Â  Â  Â  Â  Â  Â  <div><p class="font-semibold text-lg">${safeName}</p><p class="text-xs text-slate-400">${safeGoalName}</p></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex items-center"><span class="font-bold text-red-500">-1</span><button class="log-vikarma-btn text-xs bg-red-500 text-white px-3 py-1 rounded-md mx-2" aria-label="Log negative action">Log</button>${deleteBtnHTML}</div></div>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  dom.taskList.appendChild(li);
Â  Â  Â  });
Â  Â  }

Â  Â  function renderBadges() {
Â  Â  Â  dom.sidebarBadgeContainer.innerHTML = '';
Â  Â  Â  badges.forEach(badge => {
Â  Â  Â  Â  const isUnlocked = Array.isArray(state.unlockedBadges) && state.unlockedBadges.includes(badge.name);
Â  Â  Â  Â  const badgeEl = document.createElement('div');
Â  Â  Â  Â  badgeEl.className = `badge p-2 rounded-lg cursor-pointer ${isUnlocked ? 'unlocked' : 'locked'}`;
Â  Â  Â  Â  badgeEl.title = isUnlocked ? `${badge.name} - Unlocked!` : `${badge.name} - Locked`;
Â  Â  Â  Â  badgeEl.dataset.badgeName = badge.name;
Â  Â  Â  Â  badgeEl.innerHTML = `<i class="fas ${badge.icon} text-3xl ${isUnlocked ? badge.color : 'text-slate-400'}" aria-hidden="true"></i>`;
Â  Â  Â  Â  dom.sidebarBadgeContainer.appendChild(badgeEl);
Â  Â  Â  });
Â  Â  }

Â  Â  function updateStats() {
Â  Â  Â  animateValue(dom.dailyKarmaScoreEl, state.dailyKarma || 0);
Â  Â  Â  animateValue(dom.totalKarmaScoreEl, state.totalKarma || 0);
Â  Â  Â  [dom.dailyKarmaScoreEl, dom.totalKarmaScoreEl].forEach(el => {
Â  Â  Â  Â  const value = parseInt(el.textContent) || 0;
Â  Â  Â  Â  el.classList.remove('karma-positive', 'karma-negative', 'karma-neutral');
Â  Â  Â  Â  if (value > 0) el.classList.add('karma-positive');
Â  Â  Â  Â  else if (value < 0) el.classList.add('karma-negative');
Â  Â  Â  Â  else el.classList.add('karma-neutral');
Â  Â  Â  });
Â  Â  }

Â  Â  // --- Core Logic + hooks ---
Â  Â  function addGoal() {
Â  Â  Â  const name = dom.goalNameInput.value.trim();
Â  Â  Â  if (!name) { showMessage("Practice name cannot be empty.", "error"); return; }
Â  Â  Â  state.goals.push({ id: makeId(), name, satatya: 0, totalPracticeKarma: 0, hadTasksToday: false, completedOneToday: false });
Â  Â  Â  dom.goalNameInput.value = '';
Â  Â  Â  saveState();
Â  Â  }

Â  Â  function openAddKarmaModal() {
Â  Â  Â  if (state.goals.length === 0) { showMessage("Please create a Practice first.", "error"); return; }
Â  Â  Â  dom.karmaGoalSelect.innerHTML = state.goals.map(g => `<option value="${String(g.id)}">${esc(g.name)}</option>`).join('');
Â  Â  Â  dom.addKarmaForm.reset();
Â  Â  Â  dom.addKarmaModal.classList.remove('hidden');
Â  Â  }

Â  Â  function handleAddKarma(e) {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const goalId = String(dom.karmaGoalSelect.value);
Â  Â  Â  const name = dom.addKarmaForm.querySelector('#karma-name').value.trim();
Â  Â  Â  const type = dom.addKarmaForm.querySelector('#karma-type').value;
Â  Â  Â  const remindAt = dom.addKarmaForm.querySelector('#karma-remind-at')?.value || null;
Â  Â  Â  const deadlineAt = dom.addKarmaForm.querySelector('#karma-deadline-at')?.value || null;
Â  Â  Â  if (!name) { showMessage("Action name is required.", "error"); return; }

Â  Â  Â  const goal = state.goals.find(g => String(g.id) === goalId);
Â  Â  Â  if (goal && type === 'karma') { goal.hadTasksToday = true; }

Â  Â  Â  state.dailyActions.push({ id: makeId(), name, type, goalId, order: state.dailyActions.length, remindAt, deadlineAt });
Â  Â  Â  dom.addKarmaModal.classList.add('hidden');
Â  Â  Â  saveState();
Â  Â  }

Â  Â  function handleTaskClick(e) {
Â  Â  Â  const fireOverlay = e.target.closest('.fire-overlay');
Â  Â  Â  const logVikarmaBtn = e.target.closest('.log-vikarma-btn');
Â  Â  Â  const deleteBtn = e.target.closest('.delete-task-btn');

Â  Â  Â  if (fireOverlay) { handleKarmaCompletion(e); return; }
Â  Â  Â  if (logVikarmaBtn) { handleVikarmaLog(e); return; }
Â  Â  Â  if (deleteBtn) { handleDeleteTask(e); return; }

Â  Â  Â  const karmaItem = e.target.closest('.karma-item');
Â  Â  Â  if (!karmaItem) return;
Â  Â  Â  const task = state.dailyActions.find(t => String(t.id) === String(karmaItem.dataset.id));
Â  Â  Â  if (!task || task.type === 'vikarma' || task.type === 'prayashchit') return;

Â  Â  Â  document.querySelectorAll('.fire-overlay').forEach(el => { if (el.parentElement !== karmaItem) el.remove(); });

Â  Â  Â  if (karmaItem.querySelector('.fire-overlay')) {
Â  Â  Â  Â  karmaItem.querySelector('.fire-overlay').remove();
Â  Â  Â  } else {
Â  Â  Â  Â  const newFireOverlay = document.createElement('div');
Â  Â  Â  Â  newFireOverlay.className = 'fire-overlay';
Â  Â  Â  Â  newFireOverlay.innerHTML = `<i class="fas fa-fire text-orange-500 text-4xl" aria-hidden="true"></i>`;
Â  Â  Â  Â  karmaItem.appendChild(newFireOverlay);
Â  Â  Â  }
Â  Â  }

Â  Â  function handleKarmaCompletion(e) {
Â  Â  Â  const karmaItem = e.target.closest('.karma-item'); if (!karmaItem) return;
Â  Â  Â  const taskId = String(karmaItem.dataset.id);
Â  Â  Â  const taskIndex = state.dailyActions.findIndex(t => String(t.id) === taskId);
Â  Â  Â  if (taskIndex === -1) return;

Â  Â  Â  const task = state.dailyActions[taskIndex];
Â  Â  Â  const goal = state.goals.find(g => String(g.id) === String(task.goalId));

Â  Â  Â  state.dailyKarma = (state.dailyKarma || 0) + 1;
Â  Â  Â  state.metrics.completedPositiveToday = (state.metrics.completedPositiveToday || 0) + 1; // NEW
Â  Â  Â  if (goal) { goal.totalPracticeKarma = (goal.totalPracticeKarma || 0) + 1; goal.completedOneToday = true; }

Â  Â  Â  state.dailyActions.splice(taskIndex, 1);

Â  Â  Â  try { dom.fireSound.currentTime = 0; dom.fireSound.play().catch(()=>{}); } catch(e){}
Â  Â  Â  if (navigator.vibrate) navigator.vibrate(50);

Â  Â  Â  karmaItem.classList.add('completed');
Â  Â  Â  setTimeout(saveState, 500);
Â  Â  }

Â  Â  function handleVikarmaLog(e) {
Â  Â  Â  const karmaItem = e.target.closest('.karma-item'); if (!karmaItem) return;
Â  Â  Â  const taskId = String(karmaItem.dataset.id);
Â  Â  Â  const taskIndex = state.dailyActions.findIndex(t => String(t.id) === taskId);
Â  Â  Â  if (taskIndex === -1) return;

Â  Â  Â  const task = state.dailyActions[taskIndex];
Â  Â  Â  const goal = state.goals.find(g => String(g.id) === String(task.goalId));

Â  Â  Â  state.dailyKarma = (state.dailyKarma || 0) - 1;
Â  Â  Â  state.metrics.loggedNegativeToday = (state.metrics.loggedNegativeToday || 0) + 1; // NEW
Â  Â  Â  if (goal) goal.totalPracticeKarma = (goal.totalPracticeKarma || 0) - 1;

Â  Â  Â  state.dailyActions.splice(taskIndex, 1);

Â  Â  Â  if (navigator.vibrate) navigator.vibrate([100, 30, 100]);

Â  Â  Â  karmaItem.classList.add('completed');
Â  Â  Â  setTimeout(saveState, 500);
Â  Â  }

Â  Â  function handleDeleteTask(e) {
Â  Â  Â  const karmaItem = e.target.closest('.karma-item'); if (!karmaItem) return;
Â  Â  Â  const taskId = String(karmaItem.dataset.id);
Â  Â  Â  const task = state.dailyActions.find(t => String(t.id) === taskId);
Â  Â  Â  if (!task) return;

Â  Â  Â  if (task.type === 'vikarma') {
Â  Â  Â  Â  showMessage('Negative actions should be logged, not deleted.', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  // FIX: Do not decrement dailyKarma when deleting a positive task.
Â  Â  Â  state.dailyActions = state.dailyActions.filter(t => String(t.id) !== taskId);
Â  Â  Â  showMessage('Action removed.', 'info');
Â  Â  Â  saveState();
Â  Â  }

Â  Â  function handleDeleteGoal(e) {
Â  Â  Â  const goalId = String(e.target.closest('.delete-goal-btn').dataset.goalId);
Â  Â  Â  openConfirmModal('Delete Practice?', 'This will remove the practice and any of its tasks for today. This cannot be undone.', () => {
Â  Â  Â  Â  state.goals = state.goals.filter(g => String(g.id) !== goalId);
Â  Â  Â  Â  state.dailyActions = state.dailyActions.filter(t => String(t.goalId) !== goalId);
Â  Â  Â  Â  showMessage('Practice removed.', 'info');
Â  Â  Â  Â  saveState();
Â  Â  Â  });
Â  Â  }

Â  Â  // Existing end-of-day flow
Â  Â  function endDay() {
Â  Â  Â  let finalDailyKarma = state.dailyKarma || 0;
Â  Â  Â  const missedKarmas = state.dailyActions.filter(t => t.type === 'karma');
Â  Â  Â  missedKarmas.forEach(() => { finalDailyKarma -= 1; });

Â  Â  Â  state.goals.forEach(goal => {
Â  Â  Â  Â  if (goal.hadTasksToday && goal.completedOneToday) {
Â  Â  Â  Â  Â  goal.satatya = (goal.satatya || 0) + 1;
Â  Â  Â  Â  Â  badges.forEach(badge => {
Â  Â  Â  Â  Â  Â  if (goal.satatya >= badge.days && (!state.unlockedBadges || !state.unlockedBadges.includes(badge.name))) {
Â  Â  Â  Â  Â  Â  Â  state.unlockedBadges = state.unlockedBadges || [];
Â  Â  Â  Â  Â  Â  Â  state.unlockedBadges.push(badge.name);
Â  Â  Â  Â  Â  Â  Â  setTimeout(() => showBadgeUnlockModal(badge), 500);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else if (goal.hadTasksToday) {
Â  Â  Â  Â  Â  goal.satatya = 0;
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  pendingFinalDailyKarma = finalDailyKarma;
Â  Â  Â  // Summary will read metrics directly for breakdown
Â  Â  Â  showSummaryModal(finalDailyKarma, missedKarmas.length);
Â  Â  }

Â  Â  function finalizeDay(finalDailyKarma, prayashchitChoice = null) {
Â  Â  Â  state.totalKarma = (state.totalKarma || 0) + finalDailyKarma;
Â  Â  Â  state.dailyKarma = 0;
Â  Â  Â  state.dailyActions = [];
Â  Â  Â  state.metrics = { completedPositiveToday: 0, loggedNegativeToday: 0 }; // reset metrics

Â  Â  Â  state.goals.forEach(g => { g.hadTasksToday = false; g.completedOneToday = false; });

Â  Â  Â  if (prayashchitChoice) {
Â  Â  Â  Â  state.dailyActions.push({ id: makeId(), name: prayashchitChoice, type: 'prayashchit', goalId: null, order: 0 });
Â  Â  Â  }
Â  Â  Â  pendingFinalDailyKarma = null;

Â  Â  Â  // mark finalized with LOCAL date
Â  Â  Â  state.lastFinalizedDate = localDateISO();
Â  Â  Â  saveState();
Â  Â  }

Â  Â  // Drag/reorder
Â  Â  let draggedItem = null;
Â  Â  dom.taskList.addEventListener('dragstart', e => {
Â  Â  Â  if (e.target.classList.contains('karma-item')) {
Â  Â  Â  Â  draggedItem = e.target;
Â  Â  Â  Â  setTimeout(() => e.target.classList.add('dragging'), 0);
Â  Â  Â  }
Â  Â  });
Â  Â  dom.taskList.addEventListener('dragover', e => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const containerRect = dom.taskList.getBoundingClientRect();
Â  Â  Â  const y = e.clientY;
Â  Â  Â  if (y < containerRect.top + 50) { window.scrollBy(0, -15); }
Â  Â  Â  else if (y > containerRect.bottom - 50) { window.scrollBy(0, 15); }

Â  Â  Â  const afterElement = getDragAfterElement(dom.taskList, y);
Â  Â  Â  if (afterElement == null) { dom.taskList.appendChild(draggedItem); }
Â  Â  Â  else { dom.taskList.insertBefore(draggedItem, afterElement); }
Â  Â  });
Â  Â  dom.taskList.addEventListener('dragend', () => {
Â  Â  Â  if (draggedItem) {
Â  Â  Â  Â  draggedItem.classList.remove('dragging');
Â  Â  Â  Â  draggedItem = null;
Â  Â  Â  Â  const newOrderedIds = [...dom.taskList.querySelectorAll('.karma-item')].map(item => String(item.dataset.id));
Â  Â  Â  Â  state.dailyActions.forEach(task => { task.order = newOrderedIds.indexOf(String(task.id)); });
Â  Â  Â  Â  saveState();
Â  Â  Â  }
Â  Â  });
Â  Â  function getDragAfterElement(container, y) {
Â  Â  Â  const draggableElements = [...container.querySelectorAll('.karma-item:not(.dragging)')];
Â  Â  Â  return draggableElements.reduce((closest, child) => {
Â  Â  Â  Â  const box = child.getBoundingClientRect();
Â  Â  Â  Â  const offset = y - box.top - box.height / 2;
Â  Â  Â  Â  if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; }
Â  Â  Â  Â  else { return closest; }
Â  Â  Â  }, { offset: Number.NEGATIVE_INFINITY }).element;
Â  Â  }

Â  Â  // Feedback
Â  Â  function showMessage(message, type = 'success') {
Â  Â  Â  const box = document.getElementById('message-box');
Â  Â  Â  box.textContent = message;
Â  Â  Â  box.className = 'fixed bottom-16 right-5 p-4 text-sm rounded-lg shadow-lg z-50 ';
Â  Â  Â  if (type === 'success') box.classList.add('bg-green-100', 'dark:bg-green-900', 'text-green-800', 'dark:text-green-200');
Â  Â  Â  else if (type === 'error') box.classList.add('bg-red-100', 'dark:bg-red-900', 'text-red-800', 'dark:text-red-200');
Â  Â  Â  else box.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-200');
Â  Â  Â  box.classList.remove('hidden');
Â  Â  Â  setTimeout(() => box.classList.add('hidden'), 3000);
Â  Â  }

Â  Â  function animateValue(element, targetValue) {
Â  Â  Â  const startValue = parseInt(element.textContent.replace(/,/g, '')) || 0;
Â  Â  Â  if (startValue === targetValue) { element.textContent = targetValue; return; }
Â  Â  Â  const duration = 300;
Â  Â  Â  let startTime = null;
Â  Â  Â  const step = (currentTime) => {
Â  Â  Â  Â  if (!startTime) startTime = currentTime;
Â  Â  Â  Â  const progress = Math.min((currentTime - startTime) / duration, 1);
Â  Â  Â  Â  element.textContent = Math.floor(progress * (targetValue - startValue) + startValue);
Â  Â  Â  Â  if (progress < 1) window.requestAnimationFrame(step);
Â  Â  Â  };
Â  Â  Â  window.requestAnimationFrame(step);
Â  Â  }

Â  Â  function showBadgeUnlockModal(badge) {
Â  Â  Â  dom.badgeModalContent.innerHTML = `
Â  Â  Â  Â  <i class="fas ${badge.icon} text-6xl mb-4 ${badge.color} badge-ceremony-icon" aria-hidden="true"></i>
Â  Â  Â  Â  <h2 class="text-3xl font-bold">Badge Unlocked!</h2>
Â  Â  Â  Â  <p class="text-xl mt-2">${esc(badge.name)}</p>
Â  Â  Â  Â  <p class="text-slate-500 dark:text-slate-400 mt-2 italic">"${esc(badge.meaning)}"</p>
Â  Â  Â  Â  <button onclick="closeModal('badge-modal')" class="mt-6 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold py-2 px-6 rounded-lg">Continue</button>`;
Â  Â  Â  dom.badgeModal.classList.remove('hidden');
Â  Â  }

Â  Â  function showBadgeInfoModal(badge) {
Â  Â  Â  dom.badgeModalContent.innerHTML = `
Â  Â  Â  Â  <i class="fas ${badge.icon} text-6xl mb-4 text-slate-400" aria-hidden="true"></i>
Â  Â  Â  Â  <h2 class="text-3xl font-bold">${esc(badge.name)}</h2>
Â  Â  Â  Â  <p class="text-slate-500 dark:text-slate-400 mt-2">Requires ${badge.days} days of SÄtatya in a single practice to unlock.</p>
Â  Â  Â  Â  <p class="text-slate-500 dark:text-slate-400 mt-2 italic">"${esc(badge.meaning)}"</p>
Â  Â  Â  Â  <button onclick="closeModal('badge-modal')" class="mt-6 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold py-2 px-6 rounded-lg">Close</button>`;
Â  Â  Â  dom.badgeModal.classList.remove('hidden');
Â  Â  }

Â  Â  // ---- Summary (with breakdown) + flexible flow ----
Â  Â  function showSummaryModal(finalDailyKarma, missedCount, opts = {}) {
Â  Â  Â  const title = opts.title || 'Day Complete';
Â  Â  Â  const earned = (opts.earned != null) ? opts.earned : (state.metrics?.completedPositiveToday || 0);
Â  Â  Â  const negatives = (opts.negatives != null) ? opts.negatives : (state.metrics?.loggedNegativeToday || 0);
Â  Â  Â  const planned = earned + (missedCount || 0);

Â  Â  Â  dom.summaryModalContent.innerHTML = `
Â  Â  Â  Â  <h2 class="text-3xl font-bold">${esc(title)}</h2>

Â  Â  Â  Â  <div class="mt-4 text-left bg-slate-100 dark:bg-slate-700 rounded-lg p-4">
Â  Â  Â  Â  Â  <div class="flex justify-between"><span>Planned (positive)</span><span class="font-semibold">${planned}</span></div>
Â  Â  Â  Â  Â  <div class="flex justify-between mt-1"><span>Earned (done)</span><span class="font-semibold karma-positive">+${earned}</span></div>
Â  Â  Â  Â  Â  <div class="flex justify-between mt-1"><span>Missed (penalty)</span><span class="font-semibold karma-negative">-${missedCount || 0}</span></div>
Â  Â  Â  Â  Â  <div class="flex justify-between mt-1"><span>Negatives logged</span><span class="font-semibold karma-negative">-${negatives}</span></div>
Â  Â  Â  Â  Â  <hr class="my-3 border-slate-300 dark:border-slate-600">
Â  Â  Â  Â  Â  <div class="flex justify-between text-lg">
Â  Â  Â  Â  Â  Â  <span>Final Karma</span>
Â  Â  Â  Â  Â  Â  <span class="font-bold ${finalDailyKarma >= 0 ? 'karma-positive' : 'karma-negative'}">${finalDailyKarma > 0 ? '+' : ''}${finalDailyKarma}</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button id="close-summary-btn" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg">Continue</button>`;
Â  Â  Â  dom.summaryModal.classList.remove('hidden');

Â  Â  Â  document.getElementById('close-summary-btn').onclick = () => {
Â  Â  Â  Â  dom.summaryModal.classList.add('hidden');
Â  Â  Â  Â  if (typeof opts.onContinue === 'function') {
Â  Â  Â  Â  Â  opts.onContinue();
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  // Default: show prayashchit if negative, else finalize now
Â  Â  Â  Â  if (finalDailyKarma < 0) {
Â  Â  Â  Â  Â  renderPrayashchitOptions();
Â  Â  Â  Â  Â  dom.prayashchitModal.classList.remove('hidden');
Â  Â  Â  Â  Â  setPrayashchitHandler(() => {
Â  Â  Â  Â  Â  Â  const selected = document.querySelector('input[name="prayashchit"]:checked');
Â  Â  Â  Â  Â  Â  const choice = selected ? selected.value : null;
Â  Â  Â  Â  Â  Â  closeModal('prayashchit-modal');
Â  Â  Â  Â  Â  Â  finalizeDay(finalDailyKarma, choice);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  finalizeDay(finalDailyKarma);
Â  Â  Â  Â  }
Â  Â  Â  };
Â  Â  }

Â  Â  function showSummaryOnlyQueued(ps) {
Â  Â  Â  showSummaryModal(ps.finalDailyKarma, ps.missedCount, {
Â  Â  Â  Â  title: `Yesterday Complete (${ps.dateISO})`,
Â  Â  Â  Â  earned: ps.earned || 0,
Â  Â  Â  Â  negatives: ps.negatives || 0,
Â  Â  Â  Â  onContinue: () => {
Â  Â  Â  Â  Â  // After acknowledging yesterday, ask for Prayashchit if needed (add to *today*)
Â  Â  Â  Â  Â  if (state.pendingPrayashchit) {
Â  Â  Â  Â  Â  Â  renderPrayashchitOptions();
Â  Â  Â  Â  Â  Â  dom.prayashchitModal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  setPrayashchitHandler(() => {
Â  Â  Â  Â  Â  Â  Â  const selected = document.querySelector('input[name="prayashchit"]:checked');
Â  Â  Â  Â  Â  Â  Â  const choice = selected ? selected.value : null;
Â  Â  Â  Â  Â  Â  Â  closeModal('prayashchit-modal');
Â  Â  Â  Â  Â  Â  Â  if (choice) {
Â  Â  Â  Â  Â  Â  Â  Â  state.dailyActions.push({ id: makeId(), name: choice, type: 'prayashchit', goalId: null, order: 0 });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  delete state.pendingPrayashchit;
Â  Â  Â  Â  Â  Â  Â  saveState();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // --- Queued Summary state ---
Â  Â  function queueSummary({ finalDailyKarma, missedCount, dateISO, earned = 0, negatives = 0 }) {
Â  Â  Â  state.pendingSummary = { finalDailyKarma, missedCount, dateISO, earned, negatives };
Â  Â  Â  state.pendingPrayashchit = finalDailyKarma < 0;
Â  Â  Â  saveState();
Â  Â  }

Â  Â  function maybeShowQueuedSummary() {
Â  Â  Â  const ps = state.pendingSummary;
Â  Â  Â  if (!ps) return;
Â  Â  Â  // Show once, then clear
Â  Â  Â  delete state.pendingSummary;
Â  Â  Â  saveState();
Â  Â  Â  showSummaryOnlyQueued(ps);
Â  Â  }

Â  Â  // Drag helpers etc already defined above...

Â  Â  function renderPrayashchitOptions() {
Â  Â  Â  const allOptions = [...prayashchitList, ...(state.customPrayashchits || [])];
Â  Â  Â  dom.prayashchitOptionsEl.innerHTML = '';
Â  Â  Â  [...allOptions].sort(() => 0.5 - Math.random()).slice(0, 3).forEach((p, i) => {
Â  Â  Â  Â  const pSafe = esc(p);
Â  Â  Â  Â  dom.prayashchitOptionsEl.innerHTML += `<label class="flex items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"><input type="radio" name="prayashchit" value="${pSafe}" class="mr-3" ${i===0 ? 'checked' : ''}>${pSafe}</label>`;
Â  Â  Â  });
Â  Â  }

Â  Â  function addCustomPrayashchit() {
Â  Â  Â  const newPrayashchit = dom.customPrayashchitInput.value.trim();
Â  Â  Â  if (newPrayashchit && !(state.customPrayashchits || []).includes(newPrayashchit)) {
Â  Â  Â  Â  state.customPrayashchits = state.customPrayashchits || [];
Â  Â  Â  Â  state.customPrayashchits.push(newPrayashchit);
Â  Â  Â  Â  dom.customPrayashchitInput.value = '';
Â  Â  Â  Â  renderPrayashchitOptions();
Â  Â  Â  Â  saveState();
Â  Â  Â  }
Â  Â  }

Â  Â  function handleResetKarma() {
Â  Â  Â  openConfirmModal('Reset All Karma?', 'This will reset your Total Karma and all Practice Karma scores to zero. This cannot be undone.', () => {
Â  Â  Â  Â  state.totalKarma = 0;
Â  Â  Â  Â  state.goals.forEach(g => g.totalPracticeKarma = 0);
Â  Â  Â  Â  showMessage('Your accumulated Karma has been reset.', 'info');
Â  Â  Â  Â  saveState();
Â  Â  Â  });
Â  Â  }

Â  Â  function openConfirmModal(title, text, onConfirm) {
Â  Â  Â  dom.confirmModalTitle.textContent = title;
Â  Â  Â  dom.confirmModalText.textContent = text;
Â  Â  Â  dom.confirmModal.classList.remove('hidden');
Â  Â  Â  confirmAction = onConfirm;
Â  Â  }

Â  Â  function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }

Â  Â  function toggleSidebar(show) {
Â  Â  Â  if (show) { dom.sidebar.classList.remove('-translate-x-full'); dom.sidebarOverlay.classList.remove('hidden'); }
Â  Â  Â  else { dom.sidebar.classList.add('-translate-x-full'); dom.sidebarOverlay.classList.add('hidden'); }
Â  Â  }

Â  Â  // ----- Prayashchit handler manager (avoid double handlers) -----
Â  Â  function setPrayashchitHandler(fn){
Â  Â  Â  dom.acceptPrayashchitBtn.onclick = null;
Â  Â  Â  dom.acceptPrayashchitBtn.onclick = fn;
Â  Â  }

Â  Â  // --- Settings UI init/bind ---
Â  Â  function initSettingsUI(){
Â  Â  Â  const s = state.settings || defaultState.settings;
Â  Â  Â  dom.remindersToggle.checked = !!s.remindersEnabled;
Â  Â  Â  dom.pushToggle.checked = !!s.pushRemindersEnabled;
Â  Â  Â  dom.endDayTimeInput.value = s.endDayTime || "22:30";
Â  Â  Â  dom.autoFinalizeInput.value = s.autoFinalizeAfterMins ?? 30;
Â  Â  }
Â  Â  function bindSettingsEvents(){
Â  Â  Â  dom.remindersToggle.addEventListener('change', () => {
Â  Â  Â  Â  state.settings.remindersEnabled = dom.remindersToggle.checked; saveState();
Â  Â  Â  });
Â  Â  Â  dom.pushToggle.addEventListener('change', async () => {
Â  Â  Â  Â  if (dom.pushToggle.checked) {
Â  Â  Â  Â  Â  const ok = await ensurePushPermission();
Â  Â  Â  Â  Â  state.settings.pushRemindersEnabled = !!ok;
Â  Â  Â  Â  Â  dom.pushToggle.checked = !!ok;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  state.settings.pushRemindersEnabled = false;
Â  Â  Â  Â  }
Â  Â  Â  Â  saveState();
Â  Â  Â  });
Â  Â  Â  dom.endDayTimeInput.addEventListener('change', () => {
Â  Â  Â  Â  state.settings.endDayTime = dom.endDayTimeInput.value || "22:30"; saveState();
Â  Â  Â  });
Â  Â  Â  dom.autoFinalizeInput.addEventListener('change', () => {
Â  Â  Â  Â  const v = parseInt(dom.autoFinalizeInput.value, 10);
Â  Â  Â  Â  state.settings.autoFinalizeAfterMins = isNaN(v) ? 30 : Math.max(5, v); saveState();
Â  Â  Â  });
Â  Â  }
Â  Â  bindSettingsEvents();

Â  Â  // --- Foreground Reminder Scheduler ---
Â  Â  let schedulerTimer = null;
Â  Â  let alreadyReminded = new Set();
Â  Â  function scheduleForegroundReminders(){
Â  Â  Â  if (schedulerTimer) clearInterval(schedulerTimer);
Â  Â  Â  schedulerTimer = setInterval(checkDueReminders, 30 * 1000);
Â  Â  Â  checkDueReminders();
Â  Â  }
Â  Â  function parseHM(hm){
Â  Â  Â  if (!hm) return null;
Â  Â  Â  const [h,m] = hm.split(':').map(Number);
Â  Â  Â  const d = new Date();
Â  Â  Â  d.setHours(h||0, m||0, 0, 0);
Â  Â  Â  return d;
Â  Â  }
Â  Â  function markKey(id, kind){ return `${id}:${kind}:${new Date().toDateString()}`; }
Â  Â  async function checkDueReminders(){
Â  Â  Â  const s = state.settings || {};
Â  Â  Â  if (!s.remindersEnabled) return;
Â  Â  Â  const now = Date.now();

Â  Â  Â  // task reminders
Â  Â  Â  (state.dailyActions || []).forEach(t => {
Â  Â  Â  Â  if (t.type !== 'karma') return;
Â  Â  Â  Â  const r = parseHM(t.remindAt);
Â  Â  Â  Â  if (!r) return;
Â  Â  Â  Â  const key = markKey(t.id, 'remind');
Â  Â  Â  Â  if (!alreadyReminded.has(key) && Math.abs(now - r.getTime()) < 60*1000) {
Â  Â  Â  Â  Â  alreadyReminded.add(key);
Â  Â  Â  Â  Â  vibrateSoft();
Â  Â  Â  Â  Â  showMessage(`Reminder: ${t.name}`, 'info');
Â  Â  Â  Â  Â  maybeNotify(`Reminder: ${t.name}`, `Do it before ${t.deadlineAt || 'deadline'}`);
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // end-day reminder
Â  Â  Â  const edt = parseHM((state.settings||{}).endDayTime);
Â  Â  Â  if (edt) {
Â  Â  Â  Â  const endKey = markKey('endday','remind');
Â  Â  Â  Â  if (!alreadyReminded.has(endKey) && Math.abs(now - edt.getTime()) < 60*1000) {
Â  Â  Â  Â  Â  alreadyReminded.add(endKey);
Â  Â  Â  Â  Â  vibrateSoft();
Â  Â  Â  Â  Â  showMessage('Time to wrap up your day. Review & complete tasks.', 'info');
Â  Â  Â  Â  Â  maybeNotify('Day Wrap-Up', 'Review todayâ€™s tasks now.');
Â  Â  Â  Â  Â  state._autoFinalizeAt = edt.getTime() + (state.settings.autoFinalizeAfterMins||30)*60*1000;
Â  Â  Â  Â  Â  saveState();
Â  Â  Â  Â  }

Â  Â  Â  Â  // auto finalize if overdue and not done yet
Â  Â  Â  Â  const todayLocal = localDateISO();
Â  Â  Â  Â  if (state.lastFinalizedDate !== todayLocal && state._autoFinalizeAt && now >= state._autoFinalizeAt){
Â  Â  Â  Â  Â  const missedKarmas = state.dailyActions.filter(t => t.type === 'karma');
Â  Â  Â  Â  Â  let finalDailyKarma = (state.dailyKarma || 0) - missedKarmas.length;

Â  Â  Â  Â  Â  // queue a summary for "today" (being finalized now)
Â  Â  Â  Â  Â  queueSummary({
Â  Â  Â  Â  Â  Â  finalDailyKarma,
Â  Â  Â  Â  Â  Â  missedCount: missedKarmas.length,
Â  Â  Â  Â  Â  Â  dateISO: todayLocal,
Â  Â  Â  Â  Â  Â  earned: state.metrics?.completedPositiveToday || 0,
Â  Â  Â  Â  Â  Â  negatives: state.metrics?.loggedNegativeToday || 0
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  finalizeDay(finalDailyKarma);
Â  Â  Â  Â  Â  state.lastFinalizedDate = todayLocal;
Â  Â  Â  Â  Â  delete state._autoFinalizeAt;
Â  Â  Â  Â  Â  saveState();
Â  Â  Â  Â  Â  showMessage('Day auto-finalized.', 'success');
Â  Â  Â  Â  Â  maybeNotify('Day finalized', `Final karma: ${finalDailyKarma >= 0 ? '+' : ''}${finalDailyKarma}`);

Â  Â  Â  Â  Â  // surface it right away if app is open
Â  Â  Â  Â  Â  maybeShowQueuedSummary();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  function vibrateSoft(){ try{ if(navigator.vibrate) navigator.vibrate([30,30,30]); }catch(e){} }
Â  Â  async function maybeNotify(title, body){
Â  Â  Â  try{
Â  Â  Â  Â  if (!('Notification' in window)) return;
Â  Â  Â  Â  if (Notification.permission === 'granted') {
Â  Â  Â  Â  Â  const reg = await navigator.serviceWorker.getRegistration();
Â  Â  Â  Â  Â  if (reg) reg.showNotification(title, { body, icon: '/icons/icon-192x192.png' });
Â  Â  Â  Â  Â  else new Notification(title, { body });
Â  Â  Â  Â  }
Â  Â  Â  }catch(e){}
Â  Â  }

Â  Â  // --- Resume safety net (finalize missed day) ---
Â  Â  function maybeFinalizeMissedDay(){
Â  Â  Â  const todayLocal = localDateISO();
Â  Â  Â  if (state.lastFinalizedDate !== todayLocal){
Â  Â  Â  Â  const missedKarmas = state.dailyActions.filter(t => t.type === 'karma');
Â  Â  Â  Â  let finalDailyKarma = (state.dailyKarma || 0) - missedKarmas.length;

Â  Â  Â  Â  // infer "yesterday" as last finalized or yesterday date
Â  Â  Â  Â  const y = state.lastFinalizedDate || localDateISO(new Date(Date.now() - 86400000));

Â  Â  Â  Â  // queue yesterdayâ€™s summary BEFORE we wipe lists
Â  Â  Â  Â  queueSummary({
Â  Â  Â  Â  Â  finalDailyKarma,
Â  Â  Â  Â  Â  missedCount: missedKarmas.length,
Â  Â  Â  Â  Â  dateISO: y,
Â  Â  Â  Â  Â  earned: state.metrics?.completedPositiveToday || 0,
Â  Â  Â  Â  Â  negatives: state.metrics?.loggedNegativeToday || 0
Â  Â  Â  Â  });

Â  Â  Â  Â  finalizeDay(finalDailyKarma);
Â  Â  Â  Â  state.lastFinalizedDate = todayLocal;
Â  Â  Â  Â  saveState();
Â  Â  Â  Â  showMessage('Finalized previous day on resume.', 'info');

Â  Â  Â  Â  // show the queued summary immediately
Â  Â  Â  Â  maybeShowQueuedSummary();
Â  Â  Â  }
Â  Â  }

Â  Â  // --- Push (optional) ---
Â  Â  async function ensurePushPermission(){
Â  Â  Â  try{
Â  Â  Â  Â  if (!('Notification' in window)) { showMessage('Notifications not supported on this device.', 'error'); return false; }
Â  Â  Â  Â  const perm = await Notification.requestPermission();
Â  Â  Â  Â  if (perm !== 'granted') { showMessage('Notifications permission denied.', 'error'); return false; }
Â  Â  Â  Â  if (!messaging) messaging = firebase.messaging();
Â  Â  Â  Â  const reg = await navigator.serviceWorker.ready;
Â  Â  Â  Â  const token = await messaging.getToken({
Â  Â  Â  Â  Â  vapidKey: 'BCoF7_yJ4AcT_dyf98XjeZ8H8X3IxRmynPLGddqOsj6TcSO5Xni5Bx7nYS1FOZDzG1f03VPJ6JUXUqZ2yd_GpFs',
Â  Â  Â  Â  Â  serviceWorkerRegistration: reg
Â  Â  Â  Â  });
Â  Â  Â  Â  const uid = auth.currentUser?.uid;
Â  Â  Â  Â  if (uid && token) await db.collection('users').doc(uid).set({ fcmToken: token }, { merge: true });
Â  Â  Â  Â  showMessage('Push reminders enabled.', 'success');
Â  Â  Â  Â  return true;
Â  Â  Â  }catch(e){ console.error(e); showMessage(e.message || 'Push set-up failed.', 'error'); return false; }
Â  Â  }

Â  Â  // --- Diary / Notes ---
Â  Â  function watchNotes(){
Â  Â  Â  if (notesUnsub) notesUnsub();
Â  Â  Â  const uid = auth.currentUser?.uid;
Â  Â  Â  if (!uid) return;
Â  Â  Â  notesUnsub = db.collection('users').doc(uid).collection('notes')
Â  Â  Â  Â  .orderBy('createdAt','desc')
Â  Â  Â  Â  .onSnapshot(snap => {
Â  Â  Â  Â  Â  const list = [];
Â  Â  Â  Â  Â  snap.forEach(d => list.push({ id:d.id, ...d.data() }));
Â  Â  Â  Â  Â  renderNotes(list);
Â  Â  Â  Â  }, (err) => {
Â  Â  Â  Â  Â  console.error('notes listener error:', err);
Â  Â  Â  Â  Â  showMessage('Cannot load notes: ' + (err.message || err), 'error');
Â  Â  Â  Â  });
Â  Â  }
Â  Â  function renderNotes(list){
Â  Â  Â  const el = dom.notesList;
Â  Â  Â  el.innerHTML = '';
Â  Â  Â  if (!list.length) { el.innerHTML = `<p class="text-slate-500 italic">No notes yet.</p>`; return; }
Â  Â  Â  list.forEach(n => {
Â  Â  Â  Â  const ts = n.createdAt?.toDate?.() || (n.createdAt ? new Date(n.createdAt) : new Date());
Â  Â  Â  Â  el.innerHTML += `
Â  Â  Â  Â  Â  <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow">
Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between">
Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold">${esc(n.title||'Untitled')}</p>
Â  Â  Â  Â  Â  Â  Â  <span class="text-xs text-slate-400">${ts.toLocaleString()}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p class="mt-2 whitespace-pre-wrap">${esc(n.body||'')}</p>
Â  Â  Â  Â  Â  Â  ${n.audioUrl ? `<audio class="mt-2 w-full" controls src="${esc(n.audioUrl)}"></audio>` : ''}
Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  });
Â  Â  }
Â  Â  async function saveNote({title, body, audioBlob}){
Â  Â  Â  const uid = auth.currentUser?.uid; if (!uid) { showMessage('Not signed in.', 'error'); return; }
Â  Â  Â  try {
Â  Â  Â  Â  let audioUrl = null;
Â  Â  Â  Â  if (audioBlob){
Â  Â  Â  Â  Â  const mime = audioBlob.type || 'audio/webm';
Â  Â  Â  Â  Â  const ext =
Â  Â  Â  Â  Â  Â  mime.includes('mp4') ? 'm4a' :
Â  Â  Â  Â  Â  Â  mime.includes('mpeg') ? 'mp3' :
Â  Â  Â  Â  Â  Â  'webm';

Â  Â  Â  Â  Â  const path = `notes/${uid}/${Date.now()}.${ext}`;
Â  Â  Â  Â  Â  const ref = storage.ref().child(path);
Â  Â  Â  Â  Â  await ref.put(audioBlob, { contentType: mime });
Â  Â  Â  Â  Â  audioUrl = await ref.getDownloadURL();
Â  Â  Â  Â  }

Â  Â  Â  Â  await db.collection('users').doc(uid).collection('notes').add({
Â  Â  Â  Â  Â  title: title || '',
Â  Â  Â  Â  Â  body: body || '',
Â  Â  Â  Â  Â  audioUrl,
Â  Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  });

Â  Â  Â  Â  showMessage('Note saved.', 'success');
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('saveNote error:', e);
Â  Â  Â  Â  showMessage('Failed to save note: ' + (e.message || e), 'error');
Â  Â  Â  }
Â  Â  }

Â  Â  // Dictation (start/stop)
Â  Â  let _sr = null;
Â  Â  dom.btnDictate.onclick = () => {
Â  Â  Â  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  Â  if (!_sr) {
Â  Â  Â  Â  if (!SR) { showMessage('Speech recognition not supported. Use Record instead.', 'error'); return; }
Â  Â  Â  Â  _sr = new SR();
Â  Â  Â  Â  _sr.continuous = true;
Â  Â  Â  Â  _sr.interimResults = true;
Â  Â  Â  Â  _sr.lang = 'en-IN';
Â  Â  Â  Â  _sr.onresult = (ev) => {
Â  Â  Â  Â  Â  let txt = '';
Â  Â  Â  Â  Â  for (let i = ev.resultIndex; i < ev.results.length; i++){ txt += ev.results[i][0].transcript; }
Â  Â  Â  Â  Â  dom.noteBody.value = txt;
Â  Â  Â  Â  };
Â  Â  Â  Â  _sr.onend = () => { showMessage('Dictation ended.', 'info'); _sr = null; };
Â  Â  Â  Â  _sr.onerror = (e) => { console.error('speech error', e); showMessage('Speech error.', 'error'); _sr = null; };
Â  Â  Â  Â  _sr.start();
Â  Â  Â  Â  showMessage('Dictating... tap again to stop.', 'info');
Â  Â  Â  } else {
Â  Â  Â  Â  try { _sr.stop(); } catch(_) {}
Â  Â  Â  }
Â  Â  };

Â  Â  // Recording (cross-browser)
Â  Â  let rec, chunks = [];
Â  Â  let currentMime = '';
Â  Â  let currentExt = '';
Â  Â  function pickSupportedMime(){
Â  Â  Â  const candidates = [
Â  Â  Â  Â  'audio/webm;codecs=opus',
Â  Â  Â  Â  'audio/webm',
Â  Â  Â  Â  'audio/mp4',
Â  Â  Â  Â  'audio/mpeg'
Â  Â  Â  ];
Â  Â  Â  for (const m of candidates) {
Â  Â  Â  Â  if (window.MediaRecorder && typeof MediaRecorder.isTypeSupported === 'function' && MediaRecorder.isTypeSupported(m)) {
Â  Â  Â  Â  Â  return m;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return '';
Â  Â  }

Â  Â  dom.btnRecord.onclick = async () => {
Â  Â  Â  if (rec && rec.state === 'recording') {
Â  Â  Â  Â  try { rec.stop(); } catch(_) {}
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (!window.MediaRecorder) {
Â  Â  Â  Â  showMessage('Recording not supported on this browser. Use Dictate or type.', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  try {
Â  Â  Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
Â  Â  Â  Â  chunks = [];

Â  Â  Â  Â  currentMime = pickSupportedMime();
Â  Â  Â  Â  currentExt =
Â  Â  Â  Â  Â  currentMime.includes('mp4') ? 'm4a' :
Â  Â  Â  Â  Â  currentMime.includes('mpeg') ? 'mp3' :
Â  Â  Â  Â  Â  'webm';

Â  Â  Â  Â  rec = currentMime ? new MediaRecorder(stream, { mimeType: currentMime }) : new MediaRecorder(stream);

Â  Â  Â  Â  rec.ondataavailable = e => { if (e.data && e.data.size > 0) chunks.push(e.data); };

Â  Â  Â  Â  rec.onstop = async () => {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const type = currentMime || 'audio/webm';
Â  Â  Â  Â  Â  Â  const blob = new Blob(chunks, { type });
Â  Â  Â  Â  Â  Â  await saveNote({
Â  Â  Â  Â  Â  Â  Â  title: dom.noteTitle.value.trim(),
Â  Â  Â  Â  Â  Â  Â  body: dom.noteBody.value.trim(),
Â  Â  Â  Â  Â  Â  Â  audioBlob: blob
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error('onstop save error:', e);
Â  Â  Â  Â  Â  Â  showMessage('Could not save recording: ' + (e.message || e), 'error');
Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  stream.getTracks().forEach(t => t.stop());
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  rec.start();
Â  Â  Â  Â  showMessage(`Recording... tap again to stop (${currentExt || 'audio'})`, 'info');
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('getUserMedia error:', e);
Â  Â  Â  Â  showMessage('Mic permission denied or unavailable.', 'error');
Â  Â  Â  }
Â  Â  };

Â  Â  dom.btnSaveNote.onclick = () => saveNote({ title: dom.noteTitle.value.trim(), body: dom.noteBody.value.trim() });

Â  Â  // Tabs
Â  Â  function switchView(name){
Â  Â  Â  dom.viewTasks.classList.toggle('hidden', name!=='tasks');
Â  Â  Â  dom.viewDiary.classList.toggle('hidden', name!=='diary');
Â  Â  }
Â  Â  dom.tabTasks.onclick = () => switchView('tasks');
Â  Â  dom.tabDiary.onclick = () => switchView('diary');

Â  Â  // Gita quote
Â  Â  let _gitaShown = false;
Â  Â  function showGitaQuoteOnce(){
Â  Â  Â  if (_gitaShown) return;
Â  Â  Â  const q = gitaQuotes[Math.floor(Math.random()*gitaQuotes.length)];
Â  Â  Â  dom.gitaQuoteEl.textContent = q;
Â  Â  Â  _gitaShown = true;
Â  Â  }

Â  Â  // --- Quick Ad-hoc Vikarma ---
Â  Â  function quickLogVikarma() {
Â  Â  Â  const name = (prompt('What happened? (optional description)') || '').trim();

Â  Â  Â  // Optional: attribute to a practice by number
Â  Â  Â  let goalId = null;
Â  Â  Â  if (state.goals && state.goals.length) {
Â  Â  Â  Â  const options = state.goals.map((g, i) => `${i+1}. ${g.name}`).join('\n');
Â  Â  Â  Â  const pick = prompt(`Attribute to a practice? Enter number or leave blank:\n${options}`);
Â  Â  Â  Â  const idx = parseInt(pick, 10);
Â  Â  Â  Â  if (!isNaN(idx) && idx >= 1 && idx <= state.goals.length) {
Â  Â  Â  Â  Â  goalId = String(state.goals[idx - 1].id);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // Apply effects
Â  Â  Â  state.dailyKarma = (state.dailyKarma || 0) - 1;
Â  Â  Â  state.metrics = state.metrics || { completedPositiveToday: 0, loggedNegativeToday: 0 };
Â  Â  Â  state.metrics.loggedNegativeToday = (state.metrics.loggedNegativeToday || 0) + 1;

Â  Â  Â  if (goalId) {
Â  Â  Â  Â  const goal = state.goals.find(g => String(g.id) === goalId);
Â  Â  Â  Â  if (goal) goal.totalPracticeKarma = (goal.totalPracticeKarma || 0) - 1;
Â  Â  Â  }

Â  Â  Â  // Optional visible record
Â  Â  Â  if (name) {
Â  Â  Â  Â  state.dailyActions.push({
Â  Â  Â  Â  Â  id: makeId(),
Â  Â  Â  Â  Â  name: `Vikarma: ${name}`,
Â  Â  Â  Â  Â  type: 'vikarma',
Â  Â  Â  Â  Â  goalId,
Â  Â  Â  Â  Â  order: state.dailyActions.length
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  showMessage('Vikarma logged.', 'info');
Â  Â  Â  saveState();
Â  Â  }

Â  Â  // Events
Â  Â  dom.googleSigninBtn.addEventListener('click', () => {
Â  Â  Â  const provider = new firebase.auth.GoogleAuthProvider();
Â  Â  Â  auth.signInWithPopup(provider).catch(err => {
Â  Â  Â  Â  if (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user' || err.code === 'auth/cancelled-popup-request') {
Â  Â  Â  Â  Â  auth.signInWithRedirect(provider);
Â  Â  Â  Â  } else { showMessage(err.message, 'error'); }
Â  Â  Â  });
Â  Â  });
Â  Â  dom.googleRedirectFallback.addEventListener('click', (e) => { e.preventDefault(); const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithRedirect(provider); });

Â  Â  dom.emailSignupBtn.addEventListener('click', () => { auth.createUserWithEmailAndPassword(dom.emailInput.value, dom.passwordInput.value).catch(e => showMessage(e.message, 'error')); });
Â  Â  dom.emailSigninBtn.addEventListener('click', () => { auth.signInWithEmailAndPassword(dom.emailInput.value, dom.passwordInput.value).catch(e => showMessage(e.message, 'error')); });
Â  Â  dom.forgotPasswordBtn.addEventListener('click', async () => {
Â  Â  Â  const email = dom.emailInput.value.trim();
Â  Â  Â  if (!email) { showMessage('Enter your email above first.', 'error'); return; }
Â  Â  Â  try { await auth.sendPasswordResetEmail(email); showMessage('Password reset email sent.', 'success'); }
Â  Â  Â  catch (e) { showMessage(e.message, 'error'); }
Â  Â  });
Â  Â  dom.signoutBtn.addEventListener('click', () => auth.signOut());
Â  Â  dom.menuBtn.addEventListener('click', () => toggleSidebar(true));
Â  Â  dom.sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
Â  Â  dom.addGoalBtn.addEventListener('click', addGoal);
Â  Â  dom.sidebarGoalList.addEventListener('click', (e) => { if(e.target.closest('.delete-goal-btn')) handleDeleteGoal(e); });
Â  Â  dom.addKarmaBtn.addEventListener('click', openAddKarmaModal);
Â  Â  dom.addKarmaForm.addEventListener('submit', handleAddKarma);
Â  Â  dom.cancelAddKarmaBtn.addEventListener('click', () => closeModal('add-karma-modal'));
Â  Â  dom.taskList.addEventListener('click', handleTaskClick);
Â  Â  dom.resetDayBtn.addEventListener('click', endDay); // kept for safety, but button is hidden
Â  Â  dom.resetKarmaBtn.addEventListener('click', handleResetKarma);
Â  Â  dom.sidebarBadgeContainer.addEventListener('click', e => {
Â  Â  Â  const badgeEl = e.target.closest('.badge');
Â  Â  Â  if (!badgeEl) return;
Â  Â  Â  const badge = badges.find(b => b.name === badgeEl.dataset.badgeName);
Â  Â  Â  if (!badge) return;
Â  Â  Â  if (badgeEl.classList.contains('unlocked')) { showBadgeUnlockModal(badge); } else { showBadgeInfoModal(badge); }
Â  Â  });
Â  Â  dom.addCustomPrayashchitBtn.addEventListener('click', addCustomPrayashchit);

Â  Â  // NOTE: We do NOT keep a global acceptPrayashchit handler anymore; we set it per-flow via setPrayashchitHandler(...)

Â  Â  document.getElementById('quick-log-vikarma-btn').addEventListener('click', quickLogVikarma);

Â  Â  dom.confirmModalCancelBtn.addEventListener('click', () => closeModal('confirm-modal'));
Â  Â  dom.confirmModalConfirmBtn.addEventListener('click', () => {
Â  Â  Â  if (typeof confirmAction === 'function') { confirmAction(); }
Â  Â  Â  closeModal('confirm-modal');
Â  Â  });
Â  Â  document.addEventListener('click', e => { if (e.target.id === 'badge-modal') closeModal('badge-modal'); });
Â  Â  dom.themeToggleBtn.addEventListener('click', () => setTheme(!document.documentElement.classList.contains('dark')));

Â  </script>

Â <script>
Â  const SW_PATH = './service-worker.js'; // adjust if you renamed it

Â  if ('serviceWorker' in navigator) {
Â  Â  window.addEventListener('load', async () => {
Â  Â  Â  try {
Â  Â  Â  Â  const reg = await navigator.serviceWorker.register(SW_PATH);
Â  Â  Â  Â  console.log('SW registered:', reg);

Â  Â  Â  Â  // If there's an updated worker waiting, activate it immediately.
Â  Â  Â  Â  if (reg.waiting) {
Â  Â  Â  Â  Â  reg.waiting.postMessage({ type: 'SKIP_WAITING' });
Â  Â  Â  Â  }

Â  Â  Â  Â  // When a new worker is found, ask it to skip waiting as soon as it's installed.
Â  Â  Â  Â  reg.addEventListener('updatefound', () => {
Â  Â  Â  Â  Â  const nw = reg.installing;
Â  Â  Â  Â  Â  if (!nw) return;
Â  Â  Â  Â  Â  nw.addEventListener('statechange', () => {
Â  Â  Â  Â  Â  Â  if (nw.state === 'installed' && navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  nw.postMessage({ type: 'SKIP_WAITING' });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  // When the controller changes (new SW takes control), reload to get fresh assets.
Â  Â  Â  Â  navigator.serviceWorker.addEventListener('controllerchange', () => {
Â  Â  Â  Â  Â  // avoid infinite loop: reload once
Â  Â  Â  Â  Â  if (!window.__reloadedForSW) {
Â  Â  Â  Â  Â  Â  window.__reloadedForSW = true;
Â  Â  Â  Â  Â  Â  window.location.reload();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.log('ServiceWorker registration failed: ', err);
Â  Â  Â  }
Â  Â  });
Â  }

Â  // Install prompt handling
Â  let deferredPrompt;
Â  const installBtn = document.getElementById('installBtn');
Â  window.addEventListener('beforeinstallprompt', (e) => {
Â  Â  e.preventDefault();
Â  Â  deferredPrompt = e;
Â  Â  installBtn.style.display = 'inline-block';
Â  });
Â  installBtn.addEventListener('click', async () => {
Â  Â  installBtn.style.display = 'none';
Â  Â  if (deferredPrompt) {
Â  Â  Â  deferredPrompt.prompt();
Â  Â  Â  await deferredPrompt.userChoice;
Â  Â  Â  deferredPrompt = null;
Â  Â  }
Â  });
Â  window.addEventListener('appinstalled', () => {
Â  Â  installBtn.style.display = 'none';
Â  Â  deferredPrompt = null;
Â  });
</script>

</body>
</html>
